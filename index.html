<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VA ECMO: Differential Hypoxia (Trainer V2.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f5; 
            color: #1f2937; 
            overscroll-behavior: none;
        }
        .content-wrapper { max-width: 1400px; margin: 0 auto; }
        .card {
            background-color: #ffffff; border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 2px 4px rgba(0,0,0,0.05); 
            padding: 20px; transition: all 0.3s ease-out;
        }
        .card:hover { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.07), 0 4px 8px rgba(0,0,0,0.06); }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;
        }
        .section-title { font-size: 1.125rem; font-weight: 600; color: #111827; }
        .section-title-collapsible { margin-bottom: 0 !important; border-bottom: none !important; }

        .btn {
            padding: 10px 18px; border-radius: 8px; font-size: 0.875rem; font-weight: 500;
            transition: all 0.2s ease-out; cursor: pointer; border: none;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-primary { background-color: #007aff; color: white; }
        .btn-primary:hover { background-color: #005ecb; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-event { background-color: #ff3b30; color: white; } 
        .btn-action { background-color: #34c759; color: white; }
        .btn-action:hover { background-color: #2ca049; }
        .btn-finish { background-color: #ff9500; color: white; }
        .btn-finish:hover { background-color: #d97e00; }
        .btn-debrief { background-color: #5856d6; color: white; }
        .btn-debrief:hover { background-color: #4845b6; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .input-slider {
            -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e5e7eb;
            outline: none; opacity: 1; transition: opacity .2s; border-radius: 3px; cursor: pointer;
        }
        .input-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            background: #007aff; border-radius: 50%; border: 3px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .input-slider::-moz-range-thumb {
            width: 18px; height: 18px; background: #007aff; border-radius: 50%; border: 3px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;
        }
        select.custom-select, .trainer-input {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.25em;
            padding-right: 2.5rem;
        }
        .trainer-input { /* For number inputs in trainer section */
            background-image: none; /* Remove dropdown arrow */
            padding-right: 0.75rem;
        }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-out, visibility 0s 0.3s linear; }
        .modal.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
        .modal-content { background-color: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 680px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); transform: scale(0.95); transition: transform 0.3s ease-out; }
        .modal.active .modal-content { transform: scale(1); }
        
        .log-message { border-bottom: 1px solid #f3f4f6; padding: 6px 2px; font-size: 0.8rem; }
        .log-message:last-child { border-bottom: none; }
        .log-message.narrative { font-style: italic; color: #581c87; background-color: #f3e8ff; padding: 6px; border-radius: 6px; margin-bottom:3px;}
        .log-message.event { font-weight: 500; color: #5856d6; } 
        .log-message.warning { color: #ff9500; font-weight: 500;}
        .log-message.critical { color: #ff3b30; font-weight: 600; background-color: #ffe5e5; padding: 6px; border-radius: 6px;}
        .log-message.success { color: #34c759; background-color: #e6f7ea; font-weight: 500; padding: 6px; border-radius: 6px;}
        .log-message.intervention { color: #007aff; background-color: #e5f2ff; padding: 6px; border-radius: 6px;}
        .log-message.trainer { font-weight: 500; color: #4a00e0; background-color: #eadaff; padding: 6px; border-radius: 6px; margin-bottom:3px;} /* Trainer log style */
        
        .history-panel { background-color: #eef2ff; border-left: 4px solid #4f46e5; padding: 12px; margin-bottom: 16px; border-radius: 8px;}
        
        #vitalsMonitor {
            background-color: #1a202c; color: #e2e8f0; padding: 16px; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: grid; grid-template-columns: 1fr 250px; gap: 12px; margin-bottom: 20px; border: 1px solid #2d3748;
        }
        .waveforms-column { display: flex; flex-direction: column; gap: 8px; }
        .waveform-container { background-color: #0d1117; border-radius: 8px; padding: 8px; height: 100px; position: relative; }
        .waveform-container canvas { width: 100%; height: 100%; }
        .waveform-label { position: absolute; top: 4px; left: 8px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; }
         #ecgLabel { color: #30d158; } #spo2PlethLabel { color: #0a84ff; } #artLabel { color: #ff453a; } 
        .numerics-column { display: flex; flex-direction: column; justify-content: space-around; background-color: #2d3748; border-radius: 8px; padding: 12px; }
        .vital-display { text-align: right; padding: 4px 0; }
        .vital-display .label { font-size: 0.8rem; text-transform: uppercase; color: #a0aec0; margin-bottom: 0; display: inline-block; width: 60px; text-align: left; }
        .vital-display .value { font-size: 1.75rem; font-weight: 600; line-height: 1.1; display: inline-block; margin-left: 8px; }
        .vital-display .unit { font-size: 0.7rem; color: #a0aec0; margin-left: 4px; display: inline-block; }
        #hrDisplayValue { color: #30d158; } #bpDisplayValue, #meanBpDisplayValue { color: #ff453a; } 
        #spo2DisplayValue { color: #0a84ff; } #spo2RarmDisplayValue.low-sat { color: #ff9f0a !important; } 
        #tempDisplayValue { color: #ff9f0a; } #cvpDisplayValue { color: #bf5af2; } #papDisplayValue { color: #f59e0b;} 

        .dial-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 12px; }
        .dial { width: 72px; height: 72px; border-radius: 50%; background-color: #f3f4f6; position: relative; display: flex; justify-content: center; align-items: center; border: 1px solid #e5e7eb; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); }
        .dial-needle { width: 2px; height: 30px; background-color: #007aff; position: absolute; bottom: 50%; left: calc(50% - 1px); transform-origin: bottom center; transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); border-radius: 1px; }
        .dial-center-dot { width: 8px; height: 8px; background-color: #007aff; border-radius: 50%; z-index: 1;}
        .dial-value-display { font-size: 0.875rem; font-weight: 600; color: #111827; margin-top: 6px; }
        .dial-label { font-size: 0.75rem; color: #4b5563; margin-bottom: 4px; }
        .dial-controls { display: flex; justify-content: center; align-items: center; margin-top: 8px;}
        .dial-btn { background-color: #e5e7eb; color: #374151; border: none; width: 28px; height: 28px; border-radius: 50%; margin: 0 6px; font-size: 1.1rem; line-height: 1; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s ease-out; }
        .dial-btn:hover { background-color: #d1d5db; }
        #actualEcmoFlowDisplayContainer { background-color: #f9fafb; padding: 8px 12px; border-radius: 8px; margin-top: 10px; text-align: center; border: 1px solid #e5e7eb; }
        #actualEcmoFlowDisplayContainer .label { font-size: 0.8rem; color: #4b5563; display: block; }
        #actualEcmoFlowDisplayContainer .value { font-size: 1.375rem; font-weight: 600; color: #007aff; }

        #ventilatorWaveformContainer { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 12px; border-radius: 12px; margin-top: 12px; height: 160px; }
        .vent-param-label { color: #374151; font-weight: 500; }
        .vent-param-value-display { color: #007aff; font-weight: 600;}
        .vent-param-unit { color: #6b7280; }
        #ventilatorSettingsContent, #trainerControlsContent { max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), padding 0.5s cubic-bezier(0.25, 0.1, 0.25, 1); padding-top: 0; padding-bottom: 0; }
        #ventilatorSettingsContent.expanded, #trainerControlsContent.expanded { max-height: 1000px; padding-top: 8px; padding-bottom: 8px; }
        
        .cannula-box { width: 160px; height: 120px; border: 1px solid #d1d5db; display: flex; justify-content: space-around; align-items: center; padding: 0px 8px 0px 8px; margin: 12px auto; background-color: #f9fafb; border-radius: 12px; overflow: hidden; }
        .cannula { width: 20px; height: 90%; border: 1px solid #4b5563; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); box-shadow: inset 0 0 3px rgba(0,0,0,0.2); transition: background-color 0.5s ease-out; flex-direction: column; text-align: center; padding: 2px;}
        #accessCannula { background-color: #059669; } #returnCannula { background-color: #dc2626; } 
        .cannula-label { font-size: 0.55rem; margin-top: 2px; }
        
        #ecmoPressureConsole { background-color: #f9fafb; border-radius: 12px; padding: 10px 16px; margin-top: 12px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #e5e7eb; }
        .pressure-item { text-align: center; }
        .pressure-label { font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0px; }
        .pressure-value { font-size: 1.5rem; font-weight: 600; line-height: 1.1; }
        .pressure-unit { font-size: 0.7rem; color: #6b7280; display: block; margin-top: -2px; }
        #p1DisplayValue { color: #ef4444; } #p2DisplayValue { color: #f59e0b; } #p3DisplayValue { color: #22c55e; }

        .custom-dropdown-container { position: relative; width: 100%; }
        .custom-dropdown-button { background-color: white; border: 1px solid #d1d5db; border-radius: 8px; padding: 10px 12px; font-size: 0.875rem; width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .custom-dropdown-button:hover { border-color: #a0aec0; }
        .custom-dropdown-button:focus, .custom-dropdown-button.open { outline: none; border-color: #007aff; box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); }
        .custom-dropdown-options { position: absolute; background-color: white; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; max-height: 200px; overflow-y: auto; z-index: 20; box-shadow: 0 8px 16px rgba(0,0,0,0.1); opacity: 0; visibility: hidden; transform: translateY(5px); transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0s 0.2s linear; }
        .custom-dropdown-options.open { opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .custom-dropdown-options a { display: block; padding: 10px 12px; font-size: 0.875rem; color: #374151; text-decoration: none; cursor: pointer; }
        .custom-dropdown-options a:hover { background-color: #f4f4f5; }
        .arrow-icon { transition: transform 0.3s ease-out; }
        .arrow-icon.rotated { transform: rotate(180deg); }
        .hidden { display: none !important; } 

        .text-label { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 4px; display: block; }
        .text-value { font-size: 0.875rem; color: #1f2937; }
        .text-xs { font-size: 0.8rem; } 

        .debrief-column .list-disc { max-height: 300px; overflow-y: auto; padding-right: 8px; } 
        .debrief-column h5 { margin-bottom: 8px; } 
        .debrief-column .ideal-step { margin-bottom: 4px; }
        
        .action-taken-good { color: #16a34a; } /* Green */
        .action-taken-missed { color: #dc2626; } /* Red */
        .action-taken-consider { color: #f59e0b; } /* Amber */

        .trainer-control-item { margin-bottom: 12px; }
        .trainer-control-item label { display: block; font-size: 0.8rem; color: #4b5563; margin-bottom: 4px; }
        .trainer-control-item .value-display { font-weight: 600; color: #007aff; margin-left: 6px;}
        .trainer-control-item input[type="checkbox"] { width: 1rem; height: 1rem; margin-right: 6px; accent-color: #007aff; }

    </style>
</head>
<body class="p-4 md:p-6 space-y-6">
    <div class="content-wrapper">
        <div class="history-panel">
            <h2 class="text-md font-semibold text-indigo-700 mb-1">Patient History</h2>
            <p class="text-xs text-gray-700" id="patientHistoryDisplay">Loading history...</p>
        </div>

        <div id="vitalsMonitor">
            <div class="waveforms-column">
                <div class="waveform-container">
                    <span id="ecgLabel" class="waveform-label">ECG II</span>
                    <canvas id="ecgWaveformChart"></canvas>
                </div>
                <div class="waveform-container">
                    <span id="artLabel" class="waveform-label">ART</span>
                    <canvas id="arterialLineChart"></canvas>
                </div>
                <div class="waveform-container">
                     <span id="spo2PlethLabel" class="waveform-label">Pleth</span>
                    <canvas id="spo2PlethWaveformChart"></canvas>
                </div>
            </div>
            <div class="numerics-column">
                <div class="vital-display">
                    <span class="label">HR</span>
                    <span class="value" id="hrDisplayValue">105</span>
                    <span class="unit">bpm</span>
                </div>
                <div class="vital-display">
                    <span class="label">ART</span>
                    <span class="value" id="bpDisplayValue">95/60</span>
                    <span class="unit">mmHg</span>
                </div>
                <div class="vital-display">
                    <span class="label">Mean</span>
                    <span class="value" id="meanBpDisplayValue">72</span>
                    <span class="unit">mmHg</span>
                </div>
                <div class="vital-display"> <span class="label">SpO2</span> 
                    <span class="value" id="spo2DisplayValue">99</span>
                    <span class="unit">%</span>
                </div>
                 <div class="vital-display"> <span class="label">SpO2 RA</span>
                    <span class="value" id="spo2RarmDisplayValue">88</span>
                    <span class="unit">%</span>
                </div>
                <div class="vital-display">
                    <span class="label">CVP</span>
                    <span class="value" id="cvpDisplayValue">10</span>
                    <span class="unit">mmHg</span>
                </div>
                 <div class="vital-display">
                    <span class="label">PA Dias</span>
                    <span class="value" id="papDisplayValue">28</span>
                    <span class="unit">mmHg</span>
                </div>
                <div class="vital-display">
                    <span class="label">Temp</span>
                    <span class="value" id="tempDisplayValue">36.8</span>
                    <span class="unit">&deg;C</span>
                </div>
            </div>
        </div>


        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="space-y-6"> <div class="card">
                    <div class="section-header"> <h2 class="section-title">Patient Information</h2> </div>
                    <div class="space-y-2 text-sm">
                        <p><strong class="font-medium text-gray-600">ID:</strong> <span class="text-gray-800">ECMO-DH-SIM-002</span></p>
                        <p><strong class="font-medium text-gray-600">Age:</strong> <span class="text-gray-800">62M</span></p>
                        <p><strong class="font-medium text-gray-600">Weight:</strong> <span class="text-gray-800" id="patientWeightDisplay">80 kg</span></p>
                        <p><strong class="font-medium text-gray-600">Condition:</strong> <span class="text-gray-800" id="patientConditionDisplay">Post-Valve Surgery, LV Recovery, Severe ARDS</span></p>
                        <p><strong class="font-medium text-gray-600">Cannulae:</strong> <span class="text-gray-800" id="patientCannulaeDisplay">Fem-Fem (Access 25Fr Venous, Return 19Fr Arterial)</span></p>
                        <p><strong class="font-medium text-gray-600">Scenario Time:</strong> <span id="scenarioTimeDisplay" class="text-gray-800">0</span> mins</p>
                    </div>
                </div>

                <div class="card">
                     <div class="section-header"> <h2 class="section-title">ECMO Cannula Status</h2> </div>
                    <div class="cannula-box">
                        <div id="accessCannula" class="cannula">Access <span class="cannula-label">(Venous)</span></div> 
                        <div id="returnCannula" class="cannula">Return <span class="cannula-label">(Arterial)</span></div>
                    </div>
                    <div id="ecmoPressureConsole">
                        <div class="pressure-item"> <span class="pressure-label">P1 (Access)</span> <span id="p1DisplayValue" class="pressure-value">-30</span> <span class="pressure-unit">mmHg</span> </div>
                        <div class="pressure-item"> <span class="pressure-label">P2 (Pre-Oxy)</span> <span id="p2DisplayValue" class="pressure-value">280</span> <span class="pressure-unit">mmHg</span> </div>
                        <div class="pressure-item"> <span class="pressure-label">P3 (Post-Oxy)</span> <span id="p3DisplayValue" class="pressure-value">250</span> <span class="pressure-unit">mmHg</span> </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6"> <div class="card">
                    <div class="section-header"> <h2 class="section-title">ECMO Settings</h2> </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="dial-container">
                            <label class="dial-label">RPM</label> <div class="dial" id="rpmDial"> <div class="dial-needle" id="rpmNeedle"></div> <div class="dial-center-dot"></div> </div>
                            <div class="dial-value-display" id="ecmoRpmValueDisplay">3000</div>
                            <div class="dial-controls"> <button class="dial-btn" data-control="rpm" data-action="decrease">-</button> <button class="dial-btn" data-control="rpm" data-action="increase">+</button> </div>
                        </div>
                        <div class="dial-container">
                            <label class="dial-label">Sweep (L/min)</label> <div class="dial" id="sweepDial"> <div class="dial-needle" id="sweepNeedle"></div> <div class="dial-center-dot"></div> </div>
                            <div class="dial-value-display" id="ecmoSweepValueDisplay">5.0</div>
                            <div class="dial-controls"> <button class="dial-btn" data-control="sweep" data-action="decrease">-</button> <button class="dial-btn" data-control="sweep" data-action="increase">+</button> </div>
                        </div>
                        <div class="dial-container">
                            <label class="dial-label">FiO2 (%)</label> <div class="dial" id="fio2Dial"> <div class="dial-needle" id="fio2Needle"></div> <div class="dial-center-dot"></div> </div>
                            <div class="dial-value-display" id="ecmoFio2ValueDisplay">100</div>
                            <div class="dial-controls"> <button class="dial-btn" data-control="fio2" data-action="decrease">-</button> <button class="dial-btn" data-control="fio2" data-action="increase">+</button> </div>
                        </div>
                    </div>
                    <div id="actualEcmoFlowDisplayContainer"> <span class="label">Actual ECMO Flow</span> <span class="value" id="actualEcmoFlowDisplay">4.0 L/min</span> </div>
                </div>

                <div class="card">
                    <div class="section-header cursor-pointer" id="ventilatorSettingsHeader" role="button" aria-expanded="false" aria-controls="ventilatorSettingsContent">
                        <h2 class="section-title section-title-collapsible">Ventilator Settings (Lung Protective)</h2>
                        <span id="ventilatorToggleIcon" class="text-gray-500 fas fa-chevron-down transition-transform duration-300 arrow-icon"></span>
                    </div>
                    <div id="ventilatorSettingsContent" class=""> 
                        <div class="mb-3">
                            <label for="ventModeSelector" class="text-label">Mode:</label>
                            <select id="ventModeSelector" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 custom-select">
                                <option value="PCV_AC">PCV A/C</option>
                                <option value="APRV">APRV</option>
                                <option value="PRVC">PRVC</option>
                            </select>
                        </div>
                        <div id="ventilatorParamsContainer" class="space-y-2.5 mt-3 p-3 bg-slate-50 rounded-lg"> </div>
                        <div id="ventilatorWaveformContainer"> <canvas id="ventilatorWaveformChart"></canvas> </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6"> 
                 <div class="card"> 
                    <div class="section-header"> <h2 class="section-title">Diagnostics</h2> </div>
                    <div class="custom-dropdown-container">
                        <button id="diagnosticDropdownButton" class="custom-dropdown-button"> <span id="diagnosticSelectedText">Select Diagnostic...</span> <span class="fas fa-chevron-down arrow-icon text-gray-500"></span> </button>
                        <div id="diagnosticOptions" class="custom-dropdown-options">
                            <a href="#" role="option" data-value="abg_paired_radial_femoral">Paired ABG (R.Radial & Femoral/ECMO)</a>
                            <a href="#" role="option" data-value="echo_cardiac_lv_recovery">Focused ECHO (LV Function, AoV Opening, Shunt)</a>
                            <a href="#" role="option" data-value="cxr_ards">CXR (ARDS Assessment)</a> 
                            <a href="#" role="option" data-value="prePostGases_ecmo">Pre/Post Membrane Gases (ECMO Circuit)</a>
                            <a href="#" role="option" data-value="lactate_serial">Lactate (Serial)</a>
                            <a href="#" role="option" data-value="ecg_12lead_general">12-Lead ECG (General Assessment)</a>
                            <a href="#" role="option" data-value="electrolytes_full">Full Electrolyte Panel (K,Mg,Ca,Phos)</a>
                            <a href="#" role="option" data-value="cbc_coags_full">CBC & Full Coagulation Profile</a>
                        </div>
                    </div>
                    <input type="hidden" id="diagnosticSelectedValue" value="">
                </div>

                <div class="card"> 
                    <div class="section-header"> <h2 class="section-title">Interventions</h2> </div>
                    <div class="custom-dropdown-container mb-3">
                        <button id="interventionDropdownButton" class="custom-dropdown-button"> <span id="interventionSelectedText">Select Action/Procedure...</span> <span class="fas fa-chevron-down arrow-icon text-gray-500"></span> </button>
                        <div id="interventionOptions" class="custom-dropdown-options">
                            <a href="#" role="option" data-value="increase_vent_fio2">Increase Ventilator FiO2 (e.g., to 100%)</a>
                            <a href="#" role="option" data-value="increase_vent_peep">Increase Ventilator PEEP (cautiously)</a>
                            <a href="#" role="option" data-value="optimize_vent_strategy">Optimize Ventilator Strategy (e.g., APRV, recruitment)</a>
                            <hr class="my-1 border-gray-200">
                            <a href="#" role="option" data-value="increase_ecmo_flow">Increase ECMO Flow (RPM up)</a>
                            <a href="#" role="option" data-value="decrease_ecmo_flow">Decrease ECMO Flow (RPM down - cautiously if LV good)</a>
                             <hr class="my-1 border-gray-200">
                            <a href="#" role="option" data-value="admin_vasodilator_pulm">Administer Inhaled Pulmonary Vasodilator (e.g., iNO)</a>
                            <a href="#" role="option" data-value="admin_beta_blocker_careful">Administer Beta-Blocker (small dose, very cautiously)</a>
                            <a href="#" role="option" data-value="fluid_challenge_careful">Fluid Challenge (if CVP low and suspect hypovolemia)</a>
                             <hr class="my-1 border-gray-200">
                            <a href="#" role="option" data-value="consult_cardiac_surgery_ecmo">Consult Cardiac Surgery / ECMO Specialist (Re-cannulation?)</a>
                            <a href="#" role="option" data-value="initiate_vav_ecmo" class="font-semibold text-indigo-600">Initiate VAV ECMO (Resolve Differential Hypoxia)</a>
                        </div>
                    </div>
                    <input type="hidden" id="interventionSelectedValue" value="">
                 </div>
                
                <!-- Trainer Controls Card -->
                <div class="card">
                    <div class="section-header cursor-pointer" id="trainerControlsHeader" role="button" aria-expanded="false" aria-controls="trainerControlsContent">
                        <h2 class="section-title section-title-collapsible">Trainer Controls</h2>
                        <span id="trainerControlsToggleIcon" class="text-gray-500 fas fa-chevron-down transition-transform duration-300 arrow-icon"></span>
                    </div>
                    <div id="trainerControlsContent" class="space-y-3">
                        <div class="trainer-control-item">
                            <label for="trainerLungCapacitySlider">Native Lung Oxygenation Capacity: <span id="trainerLungCapacityValue" class="value-display">0.20</span></label>
                            <input type="range" id="trainerLungCapacitySlider" min="0.00" max="1.00" step="0.01" class="input-slider">
                        </div>
                        <div class="trainer-control-item">
                            <label for="trainerLvefSlider">Native LVEF: <span id="trainerLvefValue" class="value-display">0.40</span></label>
                            <input type="range" id="trainerLvefSlider" min="0.10" max="0.70" step="0.01" class="input-slider">
                        </div>
                        <div class="trainer-control-item">
                            <label for="trainerAovFactorSlider">Aortic Valve Opening Factor: <span id="trainerAovFactorValue" class="value-display">0.9</span></label>
                            <input type="range" id="trainerAovFactorSlider" min="0.1" max="1.0" step="0.01" class="input-slider">
                        </div>
                         <div class="trainer-control-item">
                            <label for="trainerCvpInput">Override CVP (mmHg): <span id="trainerCvpValue" class="value-display">10</span></label>
                            <input type="number" id="trainerCvpInput" min="0" max="30" step="1" class="w-full p-1.5 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 bg-white trainer-input">
                        </div>
                        <div class="trainer-control-item">
                            <label for="trainerLactateInput">Override Lactate (mmol/L): <span id="trainerLactateValue" class="value-display">1.8</span></label>
                            <input type="number" id="trainerLactateInput" min="0.5" max="20" step="0.1" class="w-full p-1.5 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 bg-white trainer-input">
                        </div>
                        <div class="trainer-control-item flex items-center">
                            <input type="checkbox" id="trainerInhaledNoToggle">
                            <label for="trainerInhaledNoToggle" class="ml-2 text-sm">Inhaled NO Active</label>
                        </div>
                        <div class="trainer-control-item flex items-center">
                            <input type="checkbox" id="trainerVavEcmoToggle">
                            <label for="trainerVavEcmoToggle" class="ml-2 text-sm">VAV ECMO Active</label>
                        </div>
                    </div>
                </div>
                <!-- End Trainer Controls Card -->
            </div>
        </div> 
        
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card"> <div class="section-header"> <h2 class="section-title">Scenario Control</h2> </div>
                <div class="space-y-2">
                    <button id="nextEventButton" class="w-full btn btn-event">Next Scenario Event</button>
                    <button id="finishScenarioButton" class="w-full btn btn-finish">Finish Scenario</button>
                </div>
                <div id="postScenarioOptions" class="mt-3 space-y-2 hidden">
                    <button id="debriefingButton" class="w-full btn btn-debrief">Scenario Debriefing</button>
                </div>
            </div>

            <div class="card">
                <div class="section-header"> <h2 class="section-title">Medications (General Support)</h2> </div>
                <div class="space-y-3">
                    <div>
                        <label for="sedationSlider" class="text-label">Sedation (Propofol mcg/kg/min): <span id="sedationValue" class="font-semibold text-blue-600">15</span></label>
                        <input type="range" id="sedationSlider" min="0" max="80" step="5" value="15" class="input-slider">
                    </div>
                    <div>
                        <label for="paralyticSlider" class="text-label">Paralytic (Cisatracurium mcg/kg/min): <span id="paralyticValue" class="font-semibold text-blue-600">0.3</span></label>
                        <input type="range" id="paralyticSlider" min="0" max="5" step="0.1" value="0.3" class="input-slider">
                    </div>
                     <div>
                        <label for="inotropeSlider" class="text-label">Inotrope (Dobutamine mcg/kg/min): <span id="inotropeValue" class="font-semibold text-purple-600">2</span></label>
                        <input type="range" id="inotropeSlider" min="0" max="20" step="1" value="2" class="input-slider">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 card">
             <div class="section-header"> <h2 class="section-title">Scenario Log & Messages</h2> </div>
            <div id="scenarioLog" class="h-48 overflow-y-auto text-sm space-y-1 pr-2"> </div>
        </div>
    </div> 
    
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-semibold mb-3 text-gray-800"></h3>
            <div id="modalBody" class="text-sm text-gray-700 whitespace-pre-wrap max-h-[70vh] overflow-y-auto"></div>
            <button id="closeModalButton" class="mt-5 btn btn-primary w-full">Close</button>
        </div>
    </div>

<script>
    // --- PATIENT DATA & SIMULATION LOGIC (VA ECMO - Trainer V2.0) ---
    let patientData_DH = {
        scenarioTime: 0, hr: 105, systolicBP: 95, diastolicBP: 60,  
        get meanBP() { return this.diastolicBP + Math.floor((this.systolicBP - this.diastolicBP) / 3); },
        
        spO2_femoral: 99, 
        spO2_r_arm: 82, 
        
        temp: 36.8, cvp: 10, paDiastolic: 28, 
        
        ph_systemic: 7.35, pco2_systemic: 40, po2_systemic: 95, hco3_systemic: 22, be_systemic: -2, 
        lactate: 1.8, 
        
        ph_r_radial: 7.28, pco2_r_radial: 50, po2_r_radial: 50, hco3_r_radial: 19, 
        
        potassium: 4.0, magnesium: 2.0, calcium: 8.9, sodium: 140, phosphate: 3.0,
        
        ecmoRpm: 3000, 
        currentEcmoFlow: 0, 
        ecmoSweep: 5.0, ecmoFiO2: 100,
        p1: -30, p2: 280, p3: 250, 
        preMembranePaO2: 45, preMembranePaCO2: 48, 
        postMembranePaO2: 500, postMembranePaCO2: 30,
        
        ventMode: "PCV_AC", ventFiO2: 60, 
        ventPIP_PCVAC: 28, ventPEEP_PCVAC: 12, ventRR_PCVAC: 14, 
        ventPHigh_APRV: 28, ventPLow_APRV: 8, ventTHigh_APRV: 1.5, ventTLow_APRV: 0.6, 
        ventTargetVt_PRVC: 400, ventMaxP_PRVC: 30, ventPEEP_PRVC: 12, ventRR_PRVC: 14,

        cbcHb: 9.5, cbcPlt: 180, coagINR: 1.2, coagAPTT: 40,
        sedationLevel: 15, paralyticLevel: 0.3, inotropeLevel: 2, 
        
        nativeLVEF: 0.40,                       
        aorticValveOpeningFactor: 0.9,          
        
        nativeLungOxygenationCapacity: 0.20, 
        initialNativeLungOxygenationCapacity: 0.20,
        paO2_native_lungs_floor: 25, 
        
        differentialHypoxiaActive: true, 
        inhaledNOPulmonaryVasodilatorActive: false,
        awaitingVentOptimization: false, 
        vavEcmoActive: false, 
        actionsTaken: [], weightKg: 80, 
        accessCannulaSize: "25Fr Venous", returnCannulaSize: "19Fr Arterial",
        scenarioEventTriggers: 0,
    };

    const scenarioLogEl_DH = document.getElementById('scenarioLog');
    const simulationInterval_DH = 5000; 
    const fastUpdateInterval_DH = 150; 
    let simIntervalId_DH, fastUpdateIntervalId_DH;
    let ventilatorWaveformChart_DH, arterialLineChart_DH, ecgWaveformChart_DH, spo2PlethWaveformChart_DH;
    
    let artLineWaveformPhase_DH = 0; 
    let ecgWaveformPhase_DH = 0;
    let spo2PlethWaveformPhase_DH = 0;
    const WAVEFORM_POINTS_DISPLAYED_DH = 250; 

    // Function to log actions or messages to the scenario log
    function logAction_DH(actionDescription, type = 'intervention') {
        const time = patientData_DH.scenarioTime.toFixed(1);
        patientData_DH.actionsTaken.push({ time: time, action: actionDescription, type: type });
        logMessage_DH(actionDescription, type);
    }
    function logMessage_DH(message, type = 'info') { 
        const p = document.createElement('p');
        const minutes = Math.floor(patientData_DH.scenarioTime);
        const seconds = Math.round((patientData_DH.scenarioTime - minutes) * 60);
        p.innerHTML = `<span class="font-medium text-gray-500">[${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}]</span> ${message}`;
        p.className = 'log-message'; if (type) p.classList.add(type);
        scenarioLogEl_DH.appendChild(p); scenarioLogEl_DH.scrollTop = scenarioLogEl_DH.scrollHeight; 
    }
    
    // Displays the initial patient history and logs the start of the scenario
    function displayInitialHistory_DH() {
        const history = `A 62-year-old male (${patientData_DH.weightKg} kg) s/p aortic valve replacement, complicated by severe post-operative LV dysfunction requiring VA ECMO (Fem-Fem: Access ${patientData_DH.accessCannulaSize}, Return ${patientData_DH.returnCannulaSize}). Over the past 24 hours, LV function shows significant recovery (LVEF ~${(patientData_DH.nativeLVEF*100).toFixed(0)}%, Aortic Valve Opening Factor ~${patientData_DH.aorticValveOpeningFactor.toFixed(1)}). However, patient has developed severe ARDS with worsening native lung gas exchange (current capacity factor: ${patientData_DH.nativeLungOxygenationCapacity.toFixed(2)}). Concerns for differential hypoxia are high, with initial R.Arm SpO2 noted to be significantly lower than femoral. Baseline ECMO flow ~4.0 L/min.`;
        document.getElementById('patientHistoryDisplay').textContent = history;
        document.getElementById('patientWeightDisplay').textContent = `${patientData_DH.weightKg} kg`;
        document.getElementById('patientConditionDisplay').textContent = `Post-Valve Surgery, LV Recovery, Severe ARDS, on VA ECMO`;
        document.getElementById('patientCannulaeDisplay').textContent = `Fem-Fem (Access ${patientData_DH.accessCannulaSize}, Return ${patientData_DH.returnCannulaSize})`;
        logMessage_DH(`VA ECMO (Differential Hypoxia Scenario V2.0 - Trainer Controls Added) initiated. LV recovering (LVEF ${patientData_DH.nativeLVEF.toFixed(2)}, AoV Factor ${patientData_DH.aorticValveOpeningFactor.toFixed(1)}), severe ARDS (Lung O2 Capacity: ${patientData_DH.nativeLungOxygenationCapacity.toFixed(2)}). Initial R.Arm SpO2 should reflect significant differential hypoxia. Baseline ECMO flow ~4.0 L/min (RPM: ${patientData_DH.ecmoRpm}).`, "narrative");
    }

    // Updates all vital signs monitor displays
    function updateMonitorDisplays_DH() {
        document.getElementById('hrDisplayValue').textContent = patientData_DH.hr.toFixed(0);
        document.getElementById('bpDisplayValue').textContent = `${patientData_DH.systolicBP.toFixed(0)}/${patientData_DH.diastolicBP.toFixed(0)}`;
        document.getElementById('meanBpDisplayValue').textContent = patientData_DH.meanBP.toFixed(0);
        document.getElementById('spo2DisplayValue').textContent = patientData_DH.spO2_femoral.toFixed(0);
        const spo2RarmDisplay = document.getElementById('spo2RarmDisplayValue');
        spo2RarmDisplay.textContent = patientData_DH.spO2_r_arm.toFixed(0);
        spo2RarmDisplay.classList.toggle('low-sat', patientData_DH.spO2_r_arm < 90 && !patientData_DH.vavEcmoActive); 
        document.getElementById('cvpDisplayValue').textContent = patientData_DH.cvp.toFixed(0);
        document.getElementById('papDisplayValue').textContent = patientData_DH.paDiastolic.toFixed(0); 
        document.getElementById('tempDisplayValue').textContent = patientData_DH.temp.toFixed(1);
        const minutes = Math.floor(patientData_DH.scenarioTime);
        const seconds = Math.round((patientData_DH.scenarioTime - minutes) * 60);
        document.getElementById('scenarioTimeDisplay').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // Updates ECMO, medication, and cannula status displays
    function updateControlPanelDisplays_DH() { 
        updateDial_DH('rpm', patientData_DH.ecmoRpm, dialSettings_DH.rpm.min, dialSettings_DH.rpm.max); 
        updateDial_DH('sweep', patientData_DH.ecmoSweep, dialSettings_DH.sweep.min, dialSettings_DH.sweep.max); 
        updateDial_DH('fio2', patientData_DH.ecmoFiO2, dialSettings_DH.fio2.min, dialSettings_DH.fio2.max);
        document.getElementById('actualEcmoFlowDisplay').textContent = `${patientData_DH.currentEcmoFlow.toFixed(1)} L/min`;
        document.getElementById('p1DisplayValue').textContent = patientData_DH.p1.toFixed(0);
        document.getElementById('p2DisplayValue').textContent = patientData_DH.p2.toFixed(0);
        document.getElementById('p3DisplayValue').textContent = patientData_DH.p3.toFixed(0);
        document.getElementById('sedationValue').textContent = patientData_DH.sedationLevel.toFixed(0);
        document.getElementById('paralyticValue').textContent = patientData_DH.paralyticLevel.toFixed(1);
        document.getElementById('inotropeValue').textContent = patientData_DH.inotropeLevel.toFixed(0);
        const accessCannula = document.getElementById('accessCannula');
        const returnCannula = document.getElementById('returnCannula');
        let accessSatFactor = Math.max(0, Math.min(1, (patientData_DH.preMembranePaO2 - 20) / 40)); 
        accessCannula.style.backgroundColor = `rgb(${Math.round(20 + 60 * accessSatFactor)}, ${Math.round(80 - 40 * accessSatFactor)}, ${Math.round(100 - 30 * accessSatFactor)})`; 
        let returnSatFactor = Math.max(0, Math.min(1, (patientData_DH.postMembranePaO2 - 50) / 400));
        returnCannula.style.backgroundColor = `rgb(${Math.round(220 * returnSatFactor + 30*(1-returnSatFactor))}, ${Math.round(20 + 10 * returnSatFactor)}, ${Math.round(30 + 10 * returnSatFactor)})`; 
    }
    
    // Settings for ECMO control dials
    const dialSettings_DH = { 
        rpm: { min: 1500, max: 5500, step: 100, needleId: 'rpmNeedle', displayId: 'ecmoRpmValueDisplay', patientKey: 'ecmoRpm' },
        sweep: { min: 0, max: 12, step: 0.1, needleId: 'sweepNeedle', displayId: 'ecmoSweepValueDisplay', patientKey: 'ecmoSweep' },
        fio2: { min: 21, max: 100, step: 1, needleId: 'fio2Needle', displayId: 'ecmoFio2ValueDisplay', patientKey: 'ecmoFiO2' }
    };
    // Updates a specific ECMO dial display
    function updateDial_DH(controlName, value, min, max) { 
        const setting = dialSettings_DH[controlName];
        const displayValue = (controlName === 'sweep') ? value.toFixed(1) : value.toFixed(0);
        document.getElementById(setting.displayId).textContent = displayValue;
        const percentage = (value - min) / (max - min);
        const angle = -90 + (percentage * 180); 
        document.getElementById(setting.needleId).style.transform = `rotate(${angle}deg)`;
    }
    // Event listeners for ECMO dial control buttons
    document.querySelectorAll('.dial-btn').forEach(button => { 
        button.addEventListener('click', () => {
            if (button.disabled) return;
            const control = button.dataset.control; const action = button.dataset.action;
            const setting = dialSettings_DH[control]; let currentValue = parseFloat(patientData_DH[setting.patientKey]);
            let newValue = currentValue;
            if (action === 'increase') newValue = Math.min(setting.max, currentValue + setting.step);
            else if (action === 'decrease') newValue = Math.max(setting.min, currentValue - setting.step);
            if (newValue !== currentValue) { 
                patientData_DH[setting.patientKey] = newValue; 
                logAction_DH(`Adjusted VA ECMO ${control.toUpperCase()} to ${ (control === 'sweep') ? newValue.toFixed(1) : newValue.toFixed(0) }.`); 
                updateDial_DH(control, newValue, setting.min, setting.max); 
                 checkAndApplyVentilatorOptimizationEffect_DH(); 
                 triggerFullUpdate_DH();
            }
        });
    });

    // Ventilator settings UI elements
    const ventParamsContainer_DH = document.getElementById('ventilatorParamsContainer');
    const ventModeSelector_DH = document.getElementById('ventModeSelector');
    const ventilatorSettingsHeader_DH = document.getElementById('ventilatorSettingsHeader');
    const ventilatorSettingsContent_DH = document.getElementById('ventilatorSettingsContent');
    const ventilatorToggleIcon_DH = document.getElementById('ventilatorToggleIcon');
    
    // Toggles visibility of ventilator settings card
    if (ventilatorSettingsHeader_DH && ventilatorSettingsContent_DH && ventilatorToggleIcon_DH) {
        ventilatorSettingsHeader_DH.addEventListener('click', () => { 
            if (ventilatorSettingsHeader_DH.disabled) return;
            const isExpanded = ventilatorSettingsContent_DH.classList.toggle('expanded'); 
            ventilatorSettingsHeader_DH.setAttribute('aria-expanded', isExpanded); 
            ventilatorToggleIcon_DH.classList.toggle('rotated', isExpanded); 
        });
    }
    
    // Creates an input element for a ventilator parameter
    function createVentParamInput_DH(label, id, type, value, min, max, step, unit, patientKey) {  
        const div = document.createElement('div'); div.className = 'flex justify-between items-center text-sm py-1'; 
        const labelEl = document.createElement('label'); labelEl.htmlFor = id; labelEl.className = 'font-medium vent-param-label text-gray-700'; labelEl.textContent = `${label}:`; div.appendChild(labelEl);
        const inputWrapper = document.createElement('div'); inputWrapper.className = 'flex items-center space-x-2';
        const inputEl = document.createElement('input'); inputEl.type = type; inputEl.id = id; inputEl.value = value; inputEl.min = min; inputEl.max = max; inputEl.step = step; inputEl.dataset.patientKey = patientKey; inputEl.className = 'w-24 p-1.5 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 bg-white text-right';
        inputEl.addEventListener('input', (e) => { 
            const val = parseFloat(e.target.value); 
            patientData_DH[e.target.dataset.patientKey] = val; 
            logAction_DH(`Adjusted Ventilator ${label} to ${val.toFixed(e.target.step.includes('.') ? 1 : 0)} ${unit}.`); 
            triggerFullUpdate_DH();
            checkAndApplyVentilatorOptimizationEffect_DH(); 
        });
        inputWrapper.appendChild(inputEl); 
        if (unit) { const unitEl = document.createElement('span'); unitEl.className = 'vent-param-unit text-gray-500 text-xs'; unitEl.textContent = unit; inputWrapper.appendChild(unitEl); }
        div.appendChild(inputWrapper); return div;
    }
    // Renders ventilator parameter inputs based on the selected mode
    function renderVentilatorParams_DH() { 
        ventParamsContainer_DH.innerHTML = ''; const mode = patientData_DH.ventMode;
        ventParamsContainer_DH.appendChild(createVentParamInput_DH('FiO2', 'ventFio2Input', 'number', patientData_DH.ventFiO2, 21, 100, 1, '%', 'ventFiO2'));
        if (mode === 'PCV_AC') { 
            ventParamsContainer_DH.appendChild(createVentParamInput_DH('Insp Pressure', 'ventPIP_PCVACInput', 'number', patientData_DH.ventPIP_PCVAC, 15, 35, 1, 'cmH2O', 'ventPIP_PCVAC')); 
            ventParamsContainer_DH.appendChild(createVentParamInput_DH('PEEP', 'ventPEEP_PCVACInput', 'number', patientData_DH.ventPEEP_PCVAC, 8, 24, 1, 'cmH2O', 'ventPEEP_PCVAC'));  
            ventParamsContainer_DH.appendChild(createVentParamInput_DH('Rate', 'ventRR_PCVACInput', 'number', patientData_DH.ventRR_PCVAC, 10, 25, 1, 'bpm', 'ventRR_PCVAC')); 
        } else if (mode === 'APRV') { 
             ventParamsContainer_DH.appendChild(createVentParamInput_DH('P-High', 'ventPHigh_APRVInput', 'number', patientData_DH.ventPHigh_APRV, 20, 35, 1, 'cmH2O', 'ventPHigh_APRV')); 
             ventParamsContainer_DH.appendChild(createVentParamInput_DH('P-Low', 'ventPLow_APRVInput', 'number', patientData_DH.ventPLow_APRV, 0, 15, 1, 'cmH2O', 'ventPLow_APRV')); 
             ventParamsContainer_DH.appendChild(createVentParamInput_DH('T-High', 'ventTHigh_APRVInput', 'number', patientData_DH.ventTHigh_APRV, 1.0, 5.0, 0.1, 's', 'ventTHigh_APRV')); 
             ventParamsContainer_DH.appendChild(createVentParamInput_DH('T-Low', 'ventTLow_APRVInput', 'number', patientData_DH.ventTLow_APRV, 0.2, 1.0, 0.1, 's', 'ventTLow_APRV'));
        } else if (mode === 'PRVC') {
            ventParamsContainer_DH.appendChild(createVentParamInput_DH('Target Vt', 'ventTargetVt_PRVCInput', 'number', patientData_DH.ventTargetVt_PRVC, 200, 600, 10, 'mL', 'ventTargetVt_PRVC'));
            ventParamsContainer_DH.appendChild(createVentParamInput_DH('Max Pressure', 'ventMaxP_PRVCInput', 'number', patientData_DH.ventMaxP_PRVC, 25, 40, 1, 'cmH2O', 'ventMaxP_PRVC'));
            ventParamsContainer_DH.appendChild(createVentParamInput_DH('PEEP', 'ventPEEP_PRVCInput', 'number', patientData_DH.ventPEEP_PRVC, 8, 24, 1, 'cmH2O', 'ventPEEP_PRVC'));
            ventParamsContainer_DH.appendChild(createVentParamInput_DH('Rate', 'ventRR_PRVCInput', 'number', patientData_DH.ventRR_PRVC, 10, 25, 1, 'bpm', 'ventRR_PRVC'));
        }
        updateVentilatorWaveform_DH();
    }
    // Event listener for ventilator mode change
    ventModeSelector_DH.addEventListener('change', (e) => { 
        if (ventModeSelector_DH.disabled) return;
        patientData_DH.ventMode = e.target.value; 
        logAction_DH(`Changed ventilator mode to ${patientData_DH.ventMode}.`, "intervention"); 
        renderVentilatorParams_DH(); 
        checkAndApplyVentilatorOptimizationEffect_DH(); 
        triggerFullUpdate_DH();
    });
    
    // Initializes the ventilator waveform chart
    function initVentilatorWaveform_DH() { 
        const ctx = document.getElementById('ventilatorWaveformChart').getContext('2d'); Chart.defaults.font.family = "'Inter', sans-serif"; 
        ventilatorWaveformChart_DH = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: 'Airway Pressure', data: [], borderColor: '#007aff', backgroundColor: 'rgba(0, 122, 255, 0.1)', borderWidth: 2, pointRadius: 0, tension: 0.2 }] }, options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { type: 'linear', display: true, title: { display: true, text: 'Time (s)', color: '#6b7280'}, ticks: { color: '#6b7280', font: {size: 10} }, grid: { color: '#e5e7eb'}}, y: { display: true, title: { display: true, text: 'Pressure (cmH2O)', color: '#6b7280'}, min: 0, max: 40, ticks: { color: '#6b7280', stepSize: 5, font: {size: 10} }, grid: { color: '#e5e7eb'}} }, plugins: { legend: { display: false } } } });
    }
    
    // Updates the ventilator waveform display
    let waveformTime_DH = 0; const waveformTimeStep_DH = 0.4; const waveformWindow_DH = 10; 
    function updateVentilatorWaveform_DH() { 
        if (!ventilatorWaveformChart_DH) return; 
        const data = ventilatorWaveformChart_DH.data; const now = waveformTime_DH; let pressure = 0;
        if (patientData_DH.ventMode === 'PCV_AC') { const cycleTime = 60 / Math.max(1, patientData_DH.ventRR_PCVAC); const inspTime = 0.8; const timeInCycle = now % cycleTime; pressure = (timeInCycle < inspTime) ? patientData_DH.ventPIP_PCVAC : patientData_DH.ventPEEP_PCVAC; } 
        else if (patientData_DH.ventMode === 'APRV') { const cycleTime = patientData_DH.ventTHigh_APRV + patientData_DH.ventTLow_APRV; if (cycleTime <=0) pressure = 0; else { const timeInCycle = now % cycleTime; pressure = (timeInCycle < patientData_DH.ventTHigh_APRV) ? patientData_DH.ventPHigh_APRV : patientData_DH.ventPLow_APRV; }} 
        else if (patientData_DH.ventMode === 'PRVC') { const cycleTime = 60 / Math.max(1, patientData_DH.ventRR_PRVC); const inspTime = 0.8; const timeInCycle = now % cycleTime; pressure = (timeInCycle < inspTime) ? Math.min(patientData_DH.ventMaxP_PRVC, patientData_DH.ventPEEP_PRVC + 10 + Math.random()*5) : patientData_DH.ventPEEP_PRVC; } 
        else { pressure = patientData_DH.ventPEEP_PCVAC || patientData_DH.ventPEEP_PRVC || patientData_DH.ventPLow_APRV || 10; }
        data.labels.push(now.toFixed(1)); data.datasets[0].data.push(pressure);
        while (data.labels.length > waveformWindow_DH / waveformTimeStep_DH) { data.labels.shift(); data.datasets[0].data.shift(); }
        const lastTime = parseFloat(data.labels[data.labels.length - 1] || 0);
        ventilatorWaveformChart_DH.options.scales.x.min = Math.max(0, lastTime - waveformWindow_DH + waveformTimeStep_DH); 
        ventilatorWaveformChart_DH.options.scales.x.max = Math.max(waveformWindow_DH, lastTime + waveformTimeStep_DH); 
        ventilatorWaveformChart_DH.update('none'); waveformTime_DH += waveformTimeStep_DH;
    }
    
    // Creates a generic waveform chart
    function createWaveformChart_DH(canvasId, color, yMin = 0, yMax = 100) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, { type: 'line', data: { labels: Array(WAVEFORM_POINTS_DISPLAYED_DH).fill(0).map((_, i) => i * (fastUpdateInterval_DH / 1000)), datasets: [{ data: Array(WAVEFORM_POINTS_DISPLAYED_DH).fill(yMin), borderColor: color, borderWidth: 1.5, pointRadius: 0, tension: 0.2, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { display: false }, y: { display: false, min: yMin, max: yMax } }, plugins: { legend: { display: false }, tooltip: { enabled: false } }, elements: { line: { tension: 0.4 } } } });
    }
    // Initializes all physiological waveform charts (ECG, ART, SpO2 Pleth)
    function initAllWaveforms_DH() {
        ecgWaveformChart_DH = createWaveformChart_DH('ecgWaveformChart', '#30d158', -1.5, 2.5); 
        arterialLineChart_DH = createWaveformChart_DH('arterialLineChart', '#ff453a', 0, 180); 
        spo2PlethWaveformChart_DH = createWaveformChart_DH('spo2PlethWaveformChart', '#0a84ff', 0, 100); 
    }
    // Updates ECG waveform
    function updateEcgWaveform_DH() { 
        if (!ecgWaveformChart_DH) return; const data = ecgWaveformChart_DH.data.datasets[0].data; const labels = ecgWaveformChart_DH.data.labels; const HR = patientData_DH.hr; const pointsToGenerate = Math.max(1, Math.round((fastUpdateInterval_DH / 1000) * 50)); 
        for (let i = 0; i < pointsToGenerate; i++) {
            let ecgPoint = 0; const beatDuration = 60 / Math.max(1, HR); const phase = ecgWaveformPhase_DH; 
            if (phase >= 0 && phase < 0.08 / beatDuration) { ecgPoint = 0.15 * Math.sin((phase * beatDuration / 0.08) * Math.PI); }
            const qrsStart = 0.12 / beatDuration; const qrsEnd = (0.12 + 0.09) / beatDuration;
            if (phase >= qrsStart && phase < qrsEnd) { const qrsPhase = (phase - qrsStart) / (qrsEnd - qrsStart); if (qrsPhase < 0.15) ecgPoint = -0.2 * Math.sin(qrsPhase / 0.15 * Math.PI); else if (qrsPhase < 0.5) ecgPoint = 1.5 * Math.sin((qrsPhase - 0.15) / 0.35 * Math.PI); else ecgPoint = -0.4 * Math.sin((qrsPhase - 0.5) / 0.5 * Math.PI); }
            const tStart = (0.12 + 0.09 + 0.08) / beatDuration; const tEnd = tStart + 0.20 / beatDuration;
            if (phase >= tStart && phase < tEnd) { ecgPoint = 0.3 * Math.sin((phase - tStart) / (tEnd - tStart) * Math.PI); }
            data.push(ecgPoint); labels.push(labels.length * (fastUpdateInterval_DH / 1000 / pointsToGenerate));
            ecgWaveformPhase_DH += (fastUpdateInterval_DH / 1000 / pointsToGenerate) / beatDuration;
            if (ecgWaveformPhase_DH >= 1.0) ecgWaveformPhase_DH = 0;
        }
        while (data.length > WAVEFORM_POINTS_DISPLAYED_DH) { data.shift(); labels.shift(); }
        ecgWaveformChart_DH.update('none');
    }
    // Updates Arterial Line waveform
    function updateArterialLineChart_DH() { 
        if (!arterialLineChart_DH) return; const data = arterialLineChart_DH.data.datasets[0].data; const labels = arterialLineChart_DH.data.labels; const SBP = patientData_DH.systolicBP; const DBP = patientData_DH.diastolicBP; const HR = patientData_DH.hr; const pulsePressure = Math.max(5, SBP - DBP); const pointsToGenerate = Math.max(1, Math.round( (fastUpdateInterval_DH / 1000) * 50) ); 
        for (let i = 0; i < pointsToGenerate; i++) {
            let pressure; const phase = artLineWaveformPhase_DH; const effectivePulsePressure = pulsePressure * Math.max(0.1, patientData_DH.aorticValveOpeningFactor); const nativeEjectionComponent = patientData_DH.aorticValveOpeningFactor * (0.5 + patientData_DH.nativeLVEF * 1.5 + (patientData_DH.inotropeLevel / 10) * 0.1);
            if (phase < 0.15) { pressure = DBP + (effectivePulsePressure * nativeEjectionComponent * Math.pow(phase / 0.15, 2)); } 
            else if (phase < 0.30) { pressure = (SBP * nativeEjectionComponent + DBP * (1-nativeEjectionComponent)) - (effectivePulsePressure * nativeEjectionComponent * 0.1 * Math.sin((phase - 0.15) / 0.15 * Math.PI));} 
            else if (phase < 0.40) { const notchBase = DBP + effectivePulsePressure * nativeEjectionComponent * 0.7; const notchHeight = effectivePulsePressure * nativeEjectionComponent * (0.05 + patientData_DH.aorticValveOpeningFactor * 0.05) ; pressure = notchBase + notchHeight * Math.sin((phase - 0.30) / 0.10 * Math.PI); } 
            else { const remainingPhase = phase - 0.40; const decayFactor = Math.pow(remainingPhase / 0.60, 2); pressure = (DBP + effectivePulsePressure * nativeEjectionComponent * 0.7) - (effectivePulsePressure * nativeEjectionComponent * 0.7 * decayFactor); }
            pressure = Math.max(DBP - 10, Math.min(SBP + 10, pressure)); 
            data.push(pressure); labels.push(labels.length * (fastUpdateInterval_DH / 1000 / pointsToGenerate) ); 
            const beatDuration = 60 / Math.max(1, HR); artLineWaveformPhase_DH += (fastUpdateInterval_DH / 1000 / pointsToGenerate) / beatDuration;
            if (artLineWaveformPhase_DH >= 1.0) { artLineWaveformPhase_DH = 0; }
        }
        while (data.length > WAVEFORM_POINTS_DISPLAYED_DH) { data.shift(); labels.shift(); }
        arterialLineChart_DH.options.scales.y.min = Math.max(0, DBP - 20); arterialLineChart_DH.options.scales.y.max = Math.min(200, SBP + 30); arterialLineChart_DH.update('none'); 
    }
    // Updates SpO2 Plethysmograph waveform
    function updateSpo2PlethWaveform_DH() { 
        if (!spo2PlethWaveformChart_DH) return; const data = spo2PlethWaveformChart_DH.data.datasets[0].data; const labels = spo2PlethWaveformChart_DH.data.labels; const HR = patientData_DH.hr; const spo2ValueToReflect = patientData_DH.spO2_r_arm; const pointsToGenerate = Math.max(1, Math.round((fastUpdateInterval_DH / 1000) * 50));
        for (let i = 0; i < pointsToGenerate; i++) {
            let plethPoint = 0; const beatDuration = 60 / Math.max(1, HR); const phase = spo2PlethWaveformPhase_DH; 
            const baseAmplitude = 30 + (spo2ValueToReflect / 100) * 40; const pulseAmplitude = baseAmplitude * 0.6 * Math.max(0.2, patientData_DH.aorticValveOpeningFactor); 
            if (phase < 0.3 / beatDuration) { plethPoint = baseAmplitude - pulseAmplitude + pulseAmplitude * Math.sin((phase * beatDuration / 0.3) * (Math.PI / 2)); } 
            else if (phase < 0.4 / beatDuration) { const notchPhase = (phase - 0.3 / beatDuration) / (0.1 / beatDuration); plethPoint = baseAmplitude - (pulseAmplitude * 0.15 * Math.sin(notchPhase * Math.PI)); } 
            else { const diastolePhase = (phase - 0.4 / beatDuration) / ((beatDuration - 0.4) / beatDuration); plethPoint = (baseAmplitude - pulseAmplitude * 0.15) * Math.exp(-diastolePhase * 2.5); }
            plethPoint = Math.max(0, Math.min(100, plethPoint + (Math.random()-0.5)*5 )); 
            data.push(plethPoint); labels.push(labels.length * (fastUpdateInterval_DH / 1000 / pointsToGenerate));
            spo2PlethWaveformPhase_DH += (fastUpdateInterval_DH / 1000 / pointsToGenerate) / beatDuration;
            if (spo2PlethWaveformPhase_DH >= 1.0) spo2PlethWaveformPhase_DH = 0;
        }
        while (data.length > WAVEFORM_POINTS_DISPLAYED_DH) { data.shift(); labels.shift(); }
        spo2PlethWaveformChart_DH.update('none');
    }

    // Main physiological calculation engine
    function calculateDerivedPhysiology_DH() {
        patientData_DH.p1 = -15 - (patientData_DH.ecmoRpm / 150) - (patientData_DH.cvp * 0.6); patientData_DH.p1 = Math.max(-150, patientData_DH.p1); 
        let potentialFlow = (patientData_DH.ecmoRpm - 1000) / (450); 
        let p1EffectOnFlow = (1 - Math.abs(patientData_DH.p1 / 300));
        p1EffectOnFlow = Math.max(0.5, Math.min(1, p1EffectOnFlow)); 
        patientData_DH.currentEcmoFlow = Math.max(0.5, Math.min(7.0, potentialFlow * p1EffectOnFlow));
        patientData_DH.p2 = patientData_DH.p1 + (patientData_DH.ecmoRpm / 7.5) + (patientData_DH.currentEcmoFlow * 20); patientData_DH.p3 = patientData_DH.p2 - 35 - (patientData_DH.currentEcmoFlow * 7); 
        let nativeCardiacOutput = patientData_DH.nativeLVEF * (patientData_DH.weightKg / 15) * patientData_DH.aorticValveOpeningFactor; nativeCardiacOutput *= (1 + patientData_DH.inotropeLevel * 0.05); nativeCardiacOutput = Math.max(0.5, nativeCardiacOutput); 
        let totalSystemicFlow = patientData_DH.currentEcmoFlow + nativeCardiacOutput; let systemicVascularResistanceFactor = 1.0 - (patientData_DH.sedationLevel / 200);
        patientData_DH.meanBP = (totalSystemicFlow * 80 * systemicVascularResistanceFactor) / (patientData_DH.weightKg / 12); patientData_DH.meanBP = Math.max(45, Math.min(110, patientData_DH.meanBP));
        let pulsePressure = nativeCardiacOutput * 25 * patientData_DH.aorticValveOpeningFactor; pulsePressure = Math.max(10, Math.min(60, pulsePressure));
        patientData_DH.diastolicBP = patientData_DH.meanBP - (pulsePressure / 3); patientData_DH.systolicBP = patientData_DH.diastolicBP + pulsePressure;
        patientData_DH.diastolicBP = Math.max(30, Math.min(90, patientData_DH.diastolicBP)); patientData_DH.systolicBP = Math.max(patientData_DH.diastolicBP + 5, Math.min(160, patientData_DH.systolicBP));
        patientData_DH.hr = 95 + (patientData_DH.nativeLVEF * 20) - (patientData_DH.sedationLevel * 0.2) + (patientData_DH.inotropeLevel * 1.0) + (patientData_DH.lactate - 1.5)*2; patientData_DH.hr = Math.max(60, Math.min(140, patientData_DH.hr));
        
        let ventPaO2BaseContribution = 0;
        if (patientData_DH.ventMode === "PCV_AC") ventPaO2BaseContribution = (patientData_DH.ventFiO2 * 0.5 + patientData_DH.ventPEEP_PCVAC * 2.0);
        else if (patientData_DH.ventMode === "APRV") ventPaO2BaseContribution = (patientData_DH.ventFiO2 * 0.5 + ((patientData_DH.ventPHigh_APRV + patientData_DH.ventPLow_APRV)/2 * 1.5) );
        else if (patientData_DH.ventMode === "PRVC") ventPaO2BaseContribution = (patientData_DH.ventFiO2 * 0.5 + patientData_DH.ventPEEP_PRVC * 2.0);
        
        let paO2_native_lungs;
        if (patientData_DH.vavEcmoActive) {
            paO2_native_lungs = patientData_DH.postMembranePaO2 * 0.85; 
            paO2_native_lungs = Math.max(150, Math.min(500, paO2_native_lungs)); 
        } else {
            let paO2_from_vent_and_capacity = ventPaO2BaseContribution * patientData_DH.nativeLungOxygenationCapacity;
            if (patientData_DH.inhaledNOPulmonaryVasodilatorActive) paO2_from_vent_and_capacity *= 1.2; 
            paO2_native_lungs = Math.max(patientData_DH.paO2_native_lungs_floor, Math.min(150, paO2_from_vent_and_capacity)); 
        }
        
        patientData_DH.postMembranePaO2 = patientData_DH.ecmoFiO2 * 5.0; patientData_DH.postMembranePaO2 = Math.max(100, Math.min(600, patientData_DH.postMembranePaO2));
        let nativeCO_fraction_upper = nativeCardiacOutput / (nativeCardiacOutput + patientData_DH.currentEcmoFlow * 0.1 + 0.01); 
        let mixing_adjustment_for_AoV_opening = (1 - patientData_DH.aorticValveOpeningFactor * 0.8);
        patientData_DH.po2_r_radial = (paO2_native_lungs * nativeCO_fraction_upper) + (patientData_DH.postMembranePaO2 * (1 - nativeCO_fraction_upper) * mixing_adjustment_for_AoV_opening);
        if (nativeCO_fraction_upper > 0.95 && !patientData_DH.vavEcmoActive) { 
             patientData_DH.po2_r_radial = Math.max(patientData_DH.po2_r_radial, paO2_native_lungs); 
        } else if (!patientData_DH.vavEcmoActive) {
             patientData_DH.po2_r_radial = Math.max(patientData_DH.paO2_native_lungs_floor, patientData_DH.po2_r_radial);
        } 

        let nativeCO_fraction_lower = nativeCardiacOutput / (nativeCardiacOutput + patientData_DH.currentEcmoFlow + 0.01);
        patientData_DH.po2_systemic = (paO2_native_lungs * nativeCO_fraction_lower * 0.3) + (patientData_DH.postMembranePaO2 * (1 - nativeCO_fraction_lower * 0.3)); 
        patientData_DH.po2_systemic = Math.max(30, patientData_DH.po2_systemic);
        const p50 = 27; const hill = 2.7;
        patientData_DH.spO2_r_arm = 100 * (Math.pow(patientData_DH.po2_r_radial, hill) / (Math.pow(p50, hill) + Math.pow(patientData_DH.po2_r_radial, hill))); patientData_DH.spO2_r_arm = Math.min(100, Math.max(30, patientData_DH.spO2_r_arm));
        patientData_DH.spO2_femoral = 100 * (Math.pow(patientData_DH.po2_systemic, hill) / (Math.pow(p50, hill) + Math.pow(patientData_DH.po2_systemic, hill))); patientData_DH.spO2_femoral = Math.min(100, Math.max(35, patientData_DH.spO2_femoral));
        
        let pco2_r_radial_calc = patientData_DH.postMembranePaCO2 + (nativeCO_fraction_upper * 15 * (1- (patientData_DH.vavEcmoActive ? 0.8 : patientData_DH.nativeLungOxygenationCapacity) )); 
        patientData_DH.pco2_r_radial = Math.max(20, Math.min(90, pco2_r_radial_calc));
        patientData_DH.ph_r_radial = 7.40 - ((patientData_DH.pco2_r_radial - 40) * 0.008) - (( (patientData_DH.vavEcmoActive ? 150 : 50) - patientData_DH.po2_r_radial)*0.001); 
        patientData_DH.hco3_r_radial = 24 + (patientData_DH.ph_r_radial - 7.40)*20 - (patientData_DH.pco2_r_radial - 40)*0.1; 
        patientData_DH.ph_r_radial = Math.max(6.9, Math.min(7.6, patientData_DH.ph_r_radial));
        patientData_DH.hco3_r_radial = Math.max(10, Math.min(35, patientData_DH.hco3_r_radial));

        patientData_DH.preMembranePaCO2 = 48 + patientData_DH.lactate * 0.8 - ( (patientData_DH.vavEcmoActive ? 0.8 : patientData_DH.nativeLungOxygenationCapacity) * 5); 
        patientData_DH.postMembranePaCO2 = Math.max(15, patientData_DH.preMembranePaCO2 - (patientData_DH.ecmoSweep * 5.0)); 
        patientData_DH.pco2_systemic = patientData_DH.postMembranePaCO2 + (nativeCO_fraction_lower * 10 * (1-(patientData_DH.vavEcmoActive ? 0.8 : patientData_DH.nativeLungOxygenationCapacity))); patientData_DH.pco2_systemic = Math.max(20, Math.min(70, patientData_DH.pco2_systemic));
        patientData_DH.hco3_systemic = 24 - (patientData_DH.lactate - 1.0) * 1.5 - (patientData_DH.pco2_systemic - 40) * 0.2; patientData_DH.hco3_systemic = Math.max(10, Math.min(35, patientData_DH.hco3_systemic)); 
        patientData_DH.ph_systemic = 6.1 + Math.log10(Math.max(1, patientData_DH.hco3_systemic) / (0.0301 * Math.max(10, patientData_DH.pco2_systemic))); patientData_DH.ph_systemic = Math.max(6.90, Math.min(7.60, patientData_DH.ph_systemic)); 
        patientData_DH.be_systemic = (0.9287 * patientData_DH.hco3_systemic) + (13.77 * patientData_DH.ph_systemic) - 124.58; 
        
        // Lactate calculation only if not overridden by trainer
        if (document.getElementById('trainerLactateInput').value === patientData_DH.lactate.toFixed(1)) {
            let lactateProduction = 0.01;
            if (patientData_DH.meanBP < 60) lactateProduction += (60 - patientData_DH.meanBP) * 0.0012;
            if (patientData_DH.spO2_r_arm < 85 && !patientData_DH.vavEcmoActive) lactateProduction += (85 - patientData_DH.spO2_r_arm) * 0.0008; 
            if (patientData_DH.currentEcmoFlow < (patientData_DH.weightKg * 0.030)) lactateProduction += 0.005; 
            let lactateClearance = 0.015 + (patientData_DH.currentEcmoFlow / (patientData_DH.weightKg * 0.06)) * 0.01;
            patientData_DH.lactate += (lactateProduction - lactateClearance); 
            patientData_DH.lactate = Math.max(0.8, Math.min(15, patientData_DH.lactate));
        }
        
        // CVP calculation only if not overridden by trainer
        if (document.getElementById('trainerCvpInput').value === patientData_DH.cvp.toFixed(0)) {
            patientData_DH.cvp = 8 + (patientData_DH.nativeLVEF * 10) - (patientData_DH.currentEcmoFlow*0.5); 
            patientData_DH.cvp = Math.max(3, Math.min(22, patientData_DH.cvp)); 
        }
        patientData_DH.paDiastolic = 20 + (1-(patientData_DH.vavEcmoActive ? 0.8 : patientData_DH.nativeLungOxygenationCapacity))*15 + patientData_DH.cvp * 0.3; patientData_DH.paDiastolic = Math.max(15, Math.min(50, patientData_DH.paDiastolic)); 
    }

    // Advances scenario state at each simulation interval
    function advanceScenarioState_DH() { 
        patientData_DH.scenarioTime += (simulationInterval_DH / 1000 / 60); 
        calculateDerivedPhysiology_DH(); 
        checkAndApplyVentilatorOptimizationEffect_DH(); 
        // Trainer control values are already part of patientData_DH, so they influence calculateDerivedPhysiology
        // No need to re-read from trainer inputs here, they are event-driven.
    }

    // Info modal elements and functions
    const infoModal_DH = document.getElementById('infoModal'); 
    const modalTitle_DH = document.getElementById('modalTitle'); 
    const modalBody_DH = document.getElementById('modalBody');
    
    function showInfoModal_DH(title, bodyContent) { 
        modalTitle_DH.textContent = title; modalBody_DH.innerHTML = bodyContent; infoModal_DH.classList.add('active'); 
    }
    document.getElementById('closeModalButton').addEventListener('click', () => infoModal_DH.classList.remove('active'));
    
    // Checks and applies effect of ventilator optimization if conditions are met
    function checkAndApplyVentilatorOptimizationEffect_DH() {
        if (patientData_DH.awaitingVentOptimization && patientData_DH.nativeLungOxygenationCapacity <= 0.01) { // Only try to improve if capacity is bad
            const ventFiO2Optimized = patientData_DH.ventFiO2 >= 100;
            let peepOptimized = false;
            if (patientData_DH.ventMode === "PCV_AC" && patientData_DH.ventPEEP_PCVAC >= 14) peepOptimized = true;
            else if (patientData_DH.ventMode === "PRVC" && patientData_DH.ventPEEP_PRVC >= 14) peepOptimized = true;
            else if (patientData_DH.ventMode === "APRV" && patientData_DH.ventPLow_APRV >= 6) peepOptimized = true; 

            const lastAction = patientData_DH.actionsTaken.length > 0 ? patientData_DH.actionsTaken[patientData_DH.actionsTaken.length -1] : null;
            const optimizeStrategyIntervention = lastAction && lastAction.action.toLowerCase().includes("optimize ventilator strategy");

            if (ventFiO2Optimized || peepOptimized || optimizeStrategyIntervention) {
                patientData_DH.nativeLungOxygenationCapacity = 0.20; // Improvement
                patientData_DH.awaitingVentOptimization = false;
                logAction_DH("Ventilator optimization achieved. Native lung O2 capacity improved to 0.20.", "success");
                triggerFullUpdate_DH();
            }
        } else if (patientData_DH.nativeLungOxygenationCapacity > 0.01) {
             // If lung capacity is already good (e.g. set by trainer), no longer awaiting optimization for this specific event trigger.
            patientData_DH.awaitingVentOptimization = false;
        }
    }

    // Handles selected interventions
    function performIntervention_DH(interventionValue) {
        const interventionOptionElement = document.querySelector(`#interventionOptions a[data-value="${interventionValue}"]`);
        const interventionFriendlyName = interventionOptionElement ? interventionOptionElement.textContent : "Unknown Intervention";
        switch (interventionValue) {
            case 'increase_vent_fio2': 
                patientData_DH.ventFiO2 = Math.min(100, patientData_DH.ventFiO2 + 10); 
                logAction_DH(`Increased ventilator FiO2 to ${patientData_DH.ventFiO2}%.`, "intervention"); 
                document.querySelector('#ventilatorParamsContainer input[data-patient-key="ventFiO2"]').value = patientData_DH.ventFiO2; 
                break;
            case 'increase_vent_peep':
                if (patientData_DH.ventMode === "PCV_AC") { patientData_DH.ventPEEP_PCVAC = Math.min(24, patientData_DH.ventPEEP_PCVAC + 2); document.querySelector('#ventilatorParamsContainer input[data-patient-key="ventPEEP_PCVAC"]').value = patientData_DH.ventPEEP_PCVAC; logAction_DH(`Increased PCV PEEP to ${patientData_DH.ventPEEP_PCVAC} cmH2O.`, "intervention");}
                else if (patientData_DH.ventMode === "APRV") { patientData_DH.ventPLow_APRV = Math.min(15, patientData_DH.ventPLow_APRV + 1); document.querySelector('#ventilatorParamsContainer input[data-patient-key="ventPLow_APRV"]').value = patientData_DH.ventPLow_APRV; logAction_DH(`Increased APRV P-Low to ${patientData_DH.ventPLow_APRV} cmH2O.`, "intervention");}
                else if (patientData_DH.ventMode === "PRVC") { patientData_DH.ventPEEP_PRVC = Math.min(24, patientData_DH.ventPEEP_PRVC + 2); document.querySelector('#ventilatorParamsContainer input[data-patient-key="ventPEEP_PRVC"]').value = patientData_DH.ventPEEP_PRVC; logAction_DH(`Increased PRVC PEEP to ${patientData_DH.ventPEEP_PRVC} cmH2O.`, "intervention");}
                break;
            case 'optimize_vent_strategy': 
                logAction_DH("Selected: Optimize Ventilator Strategy. Effect depends on subsequent specific adjustments or if conditions for lung improvement are met.", "intervention"); 
                showInfoModal_DH("Ventilator Strategy Optimization", "Consider recruitment maneuvers, adjust APRV T-High/T-Low, or PCV I-time/Rate to improve mean airway pressure and oxygenation, balancing lung protection. If lung capacity is critically low due to a scenario event, achieving optimal FiO2/PEEP may now improve it."); 
                break; 
            case 'increase_ecmo_flow': 
                patientData_DH.ecmoRpm = Math.min(dialSettings_DH.rpm.max, patientData_DH.ecmoRpm + 200); 
                logAction_DH(`Increased ECMO RPM to ${patientData_DH.ecmoRpm}.`, "intervention"); 
                break;
            case 'decrease_ecmo_flow': 
                patientData_DH.ecmoRpm = Math.max(dialSettings_DH.rpm.min, patientData_DH.ecmoRpm - 200); 
                logAction_DH(`Decreased ECMO RPM to ${patientData_DH.ecmoRpm}.`, "intervention"); 
                break;
            case 'admin_vasodilator_pulm': patientData_DH.inhaledNOPulmonaryVasodilatorActive = true; logAction_DH("Administered inhaled pulmonary vasodilator.", "intervention"); document.getElementById('trainerInhaledNoToggle').checked = true; break;
            case 'admin_beta_blocker_careful': patientData_DH.nativeLVEF = Math.max(0.15, patientData_DH.nativeLVEF - 0.03); patientData_DH.aorticValveOpeningFactor = Math.max(0.2, patientData_DH.aorticValveOpeningFactor - 0.05); logAction_DH("Administered small dose beta-blocker.", "intervention"); break;
            case 'fluid_challenge_careful': patientData_DH.cvp += 2; logAction_DH("Administered fluid challenge (250ml).", "intervention"); document.getElementById('trainerCvpInput').value = patientData_DH.cvp.toFixed(0); document.getElementById('trainerCvpValue').textContent = patientData_DH.cvp.toFixed(0); break;
            case 'consult_cardiac_surgery_ecmo': logAction_DH("Consulted Cardiac Surgery / ECMO Specialist.", "event"); showInfoModal_DH("Specialist Consult", "Discussion: Severity of differential hypoxia, impact on end-organ perfusion, feasibility/risks of VAV ECMO or other advanced strategies."); break;
            case 'initiate_vav_ecmo':
                patientData_DH.vavEcmoActive = true;
                patientData_DH.differentialHypoxiaActive = false; 
                patientData_DH.awaitingVentOptimization = false; 
                logAction_DH("VAV ECMO Initiated. Expect significant improvement in upper body oxygenation.", "success");
                document.getElementById('trainerVavEcmoToggle').checked = true;
                break;
            default: logMessage_DH("No intervention selected or invalid value.", "warning"); return;
        }
        document.getElementById('interventionSelectedText').textContent = "Select Action/Procedure..."; document.getElementById('interventionSelectedValue').value = ""; 
        checkAndApplyVentilatorOptimizationEffect_DH(); 
        triggerFullUpdate_DH();
        updateTrainerControlDisplays_DH(); // Ensure trainer controls reflect intervention changes
    }

    // Handles selected diagnostic tests
    function submitDiagnostic_DH(diagnosticValue) {
        const diagnosticOptionElement = document.querySelector(`#diagnosticOptions a[data-value="${diagnosticValue}"]`);
        const diagnosticFriendlyName = diagnosticOptionElement ? diagnosticOptionElement.textContent : "Unknown Diagnostic";
        let title = "", results = {}, findings = "";
        switch (diagnosticValue) {
            case 'abg_paired_radial_femoral': title = "Paired Arterial Blood Gas Report";
                results = {
                    "<b>Right Radial Artery (Upper Body)</b>": "", 
                    "  pH (R.Radial)": patientData_DH.ph_r_radial.toFixed(2), 
                    "  PaCO2 (R.Radial)": `${patientData_DH.pco2_r_radial.toFixed(0)} mmHg`, 
                    "  PaO2 (R.Radial)": `${patientData_DH.po2_r_radial.toFixed(0)} mmHg (Expected SpO2: ${patientData_DH.spO2_r_arm.toFixed(0)}%)`, 
                    "  HCO3 (R.Radial)": `${patientData_DH.hco3_r_radial.toFixed(0)} mmol/L`,
                    "<b>Femoral Artery / ECMO Return (Lower Body/Systemic)</b>": "", 
                    "  pH (Systemic)": patientData_DH.ph_systemic.toFixed(2), 
                    "  PaCO2 (Systemic)": `${patientData_DH.pco2_systemic.toFixed(0)} mmHg`, 
                    "  PaO2 (Systemic)": `${patientData_DH.po2_systemic.toFixed(0)} mmHg (Expected SpO2: ${patientData_DH.spO2_femoral.toFixed(0)}%)`, 
                    "  HCO3 (Systemic)": `${patientData_DH.hco3_systemic.toFixed(0)} mmol/L`, 
                    "  BE (Systemic)": `${patientData_DH.be_systemic.toFixed(1)} mmol/L`,
                    "<b>Lactate (Systemic)</b>": `${patientData_DH.lactate.toFixed(1)} mmol/L`
                };
                let interpretation = `<p class='mt-3 text-sm font-semibold'>Interpretation:</p><p class='text-xs'>The PaO2 in the right radial artery (${patientData_DH.po2_r_radial.toFixed(0)} mmHg) is significantly lower than the femoral/ECMO PaO2 (${patientData_DH.po2_systemic.toFixed(0)} mmHg), confirming <b>Differential Hypoxia (Harlequin Syndrome)</b>. This indicates substantial native LV ejection of poorly oxygenated blood from the failing lungs, perfusing the upper body.</p>`;
                if(patientData_DH.vavEcmoActive) { interpretation = `<p class='mt-3 text-sm font-semibold'>Interpretation (Post-VAV ECMO):</p><p class='text-xs'>VAV ECMO is active. The PaO2 in the right radial artery (${patientData_DH.po2_r_radial.toFixed(0)} mmHg) should now be similar to or higher than the femoral/ECMO PaO2 (${patientData_DH.po2_systemic.toFixed(0)} mmHg), indicating resolution of differential hypoxia.</p>`;}
                showLabResults_DH(title, results, interpretation); break;
            case 'echo_cardiac_lv_recovery': title = "Focused Echocardiogram Report"; findings = `ECHO (${patientData_DH.scenarioTime.toFixed(0)} min):\nLV Function: LVEF ${(patientData_DH.nativeLVEF*100).toFixed(0)}%. Ongoing recovery. AoV Opening Factor: ${patientData_DH.aorticValveOpeningFactor.toFixed(2)}.\nRV Function: Moderately dilated/reduced. No gross shunt. IVC: ${patientData_DH.cvp > 15 ? "Dilated" : (patientData_DH.cvp < 8 ? "Small" : "Normal")}.\nImpression: Recovering LV, significant AoV opening. Consistent with potential for differential hypoxia.`; showInfoModal_DH(title, findings); break;
            case 'cxr_ards': title = "Chest X-Ray Report"; findings = `CXR (${patientData_DH.scenarioTime.toFixed(0)} min):\nLungs: Diffuse bilateral opacities, consistent with severe ARDS. Lines in situ.\nImpression: Severe ARDS.`; showInfoModal_DH(title, findings); break;
            case 'prePostGases_ecmo': results = { "PreOxyPaO2": `${patientData_DH.preMembranePaO2.toFixed(0)}`, "PreOxyPaCO2": `${patientData_DH.preMembranePaCO2.toFixed(0)}`, "PostOxyPaO2": `${patientData_DH.postMembranePaO2.toFixed(0)}`, "PostOxyPaCO2": `${patientData_DH.postMembranePaCO2.toFixed(0)}`}; showLabResults_DH("ECMO Pre/Post Membrane Gases", results, "<p class='mt-3 text-xs'>Oxygenator functioning well.</p>"); break;
            case 'lactate_serial': results = {"Lactate": `${patientData_DH.lactate.toFixed(1)} mmol/L`}; showLabResults_DH("Serial Lactate", results); break;
            case 'ecg_12lead_general': title = "12-Lead ECG"; findings = `ECG: Sinus tachycardia ${patientData_DH.hr.toFixed(0)} bpm. No acute ischemic changes.`; showInfoModal_DH(title, findings); break;
            case 'electrolytes_full': title = "Electrolytes"; results = { "K+": `${patientData_DH.potassium.toFixed(1)}`, "Mg++": `${patientData_DH.magnesium.toFixed(1)}`, "Ca++": `${patientData_DH.calcium.toFixed(1)}`, "Phos": `${patientData_DH.phosphate.toFixed(1)}`, "Na+": `${patientData_DH.sodium.toFixed(0)}`}; showLabResults_DH(title, results); break;
            case 'cbc_coags_full': results = { Hb: `${patientData_DH.cbcHb.toFixed(1)}`, Plt: `${patientData_DH.cbcPlt.toFixed(0)}`, INR: patientData_DH.coagINR.toFixed(1), aPTT: `${patientData_DH.coagAPTT.toFixed(0)}`}; showLabResults_DH("CBC & Coags", results); break;
            default: logMessage_DH("Invalid diagnostic.", "warning"); return; 
        }
        logAction_DH(`Requested: ${diagnosticFriendlyName}`, "intervention"); 
        document.getElementById('diagnosticSelectedText').textContent = "Select Diagnostic..."; document.getElementById('diagnosticSelectedValue').value = "";
    }
    // Displays lab results in the info modal
    function showLabResults_DH(title, results, interpretation = "") {
        let body = `<table class='w-full text-sm'><thead><tr class='bg-gray-100'><th class='p-2 text-left'>Parameter</th><th class='p-2 text-left'>Value</th></tr></thead><tbody>`;
        for (const key in results) { body += `<tr><td class='p-2 border-b'>${key.startsWith('<b>') ? key : '&nbsp;&nbsp;' + key}</td><td class='p-2 border-b font-medium'>${results[key]}</td></tr>`; }
        body += "</tbody></table>"; if (interpretation) body += interpretation;
        showInfoModal_DH(title, body);
    }
    // Sets up custom dropdown menus
    function setupDropdown_DH(buttonId, optionsId, selectedTextId, selectedValueInputId, actionType) { 
        const button = document.getElementById(buttonId); const optionsDiv = document.getElementById(optionsId); const arrowIcon = button.querySelector('.arrow-icon');
        button.addEventListener('click', (event) => { 
            event.stopPropagation(); 
            if (button.disabled) return;
            const isOpen = optionsDiv.classList.toggle('open'); button.classList.toggle('open', isOpen); button.setAttribute('aria-expanded', isOpen); if(arrowIcon) arrowIcon.classList.toggle('rotated', isOpen); 
        });
        optionsDiv.addEventListener('click', (event) => { 
            if (event.target.tagName === 'A') { 
                event.preventDefault(); const value = event.target.dataset.value;
                if (actionType === 'intervention') { performIntervention_DH(value); } else if (actionType === 'diagnostic') { submitDiagnostic_DH(value); }
                optionsDiv.classList.remove('open'); button.classList.remove('open'); button.setAttribute('aria-expanded', 'false'); if(arrowIcon) arrowIcon.classList.remove('rotated'); 
            } 
        });
    }
    // Closes dropdowns if clicked outside
    document.addEventListener('click', (event) => { 
        ['interventionOptions', 'diagnosticOptions'].forEach(id => {
            const options = document.getElementById(id); const btnId = id.replace('Options', 'DropdownButton'); const button = document.getElementById(btnId); const arrowIcon = button ? button.querySelector('.arrow-icon') : null;
            if (options && options.classList.contains('open') && button && !button.contains(event.target) && !options.contains(event.target)) { options.classList.remove('open'); button.classList.remove('open'); button.setAttribute('aria-expanded', 'false'); if(arrowIcon) arrowIcon.classList.remove('rotated');}
        });
    });

    // Handles "Next Scenario Event" button click
    document.getElementById('nextEventButton').addEventListener('click', () => {
        if (document.getElementById('nextEventButton').disabled) return;
        patientData_DH.scenarioEventTriggers++; 
        logAction_DH(`Advanced to Scenario Event ${patientData_DH.scenarioEventTriggers}`, "event");

        if (patientData_DH.scenarioEventTriggers === 1) { 
            patientData_DH.nativeLVEF = 0.60;
            patientData_DH.aorticValveOpeningFactor = Math.min(1.0, patientData_DH.aorticValveOpeningFactor + 0.05); 
            patientData_DH.nativeLungOxygenationCapacity = 0.01;
            patientData_DH.awaitingVentOptimization = true; 
            logMessage_DH("EVENT 1: LV function significantly improved (LVEF to 0.60). Native lung capacity critically worsened (to 0.01). Awaiting ventilator optimization.", "critical");
        } else if (patientData_DH.scenarioEventTriggers === 2) { 
            patientData_DH.lactate += 0.5; 
            logMessage_DH("EVENT 2: Lactate trending up slightly. Continue close monitoring of perfusion and oxygenation.", "critical");
        } else if (patientData_DH.scenarioEventTriggers > 2) { 
            logMessage_DH("Further events: Differential hypoxia may be refractory if not managed. Consider advanced strategies.", "critical"); 
        }
        triggerFullUpdate_DH();
        updateTrainerControlDisplays_DH(); // Update trainer controls to reflect event changes
        document.getElementById('vitalsMonitor').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Event listeners for medication sliders
    ['sedationSlider', 'paralyticSlider', 'inotropeSlider'].forEach(id => { 
        document.getElementById(id).addEventListener('input', (e) => {
            if (e.target.disabled) return;
            const val = parseFloat(e.target.value); let actionDetail = "", previousValue; const targetValueSpanId = id.replace('Slider', 'Value'); const targetValueSpan = document.getElementById(targetValueSpanId);
            if (id === 'sedationSlider') { previousValue = patientData_DH.sedationLevel; patientData_DH.sedationLevel = val; actionDetail = `Sedation from ${previousValue.toFixed(0)} to ${val.toFixed(0)}`; targetValueSpan.textContent = val.toFixed(0);}
            else if (id === 'paralyticSlider') { previousValue = patientData_DH.paralyticLevel; patientData_DH.paralyticLevel = val; actionDetail = `Paralytic from ${previousValue.toFixed(1)} to ${val.toFixed(1)}`; targetValueSpan.textContent = val.toFixed(1);}
            else if (id === 'inotropeSlider') { previousValue = patientData_DH.inotropeLevel; patientData_DH.inotropeLevel = val; actionDetail = `Inotrope from ${previousValue.toFixed(0)} to ${val.toFixed(0)}`; targetValueSpan.textContent = val.toFixed(0);}
            logAction_DH(`Adjusted ${actionDetail}`);
            triggerFullUpdate_DH();
        });
    });
    
    // Trainer Controls Setup
    const trainerControlsHeader_DH = document.getElementById('trainerControlsHeader');
    const trainerControlsContent_DH = document.getElementById('trainerControlsContent');
    const trainerControlsToggleIcon_DH = document.getElementById('trainerControlsToggleIcon');

    if (trainerControlsHeader_DH && trainerControlsContent_DH && trainerControlsToggleIcon_DH) {
        trainerControlsHeader_DH.addEventListener('click', () => {
            if (trainerControlsHeader_DH.disabled) return;
            const isExpanded = trainerControlsContent_DH.classList.toggle('expanded');
            trainerControlsHeader_DH.setAttribute('aria-expanded', isExpanded);
            trainerControlsToggleIcon_DH.classList.toggle('rotated', isExpanded);
        });
    }

    function setupTrainerControls_DH() {
        const lungCapacitySlider = document.getElementById('trainerLungCapacitySlider');
        const lungCapacityValue = document.getElementById('trainerLungCapacityValue');
        const lvefSlider = document.getElementById('trainerLvefSlider');
        const lvefValue = document.getElementById('trainerLvefValue');
        const aovFactorSlider = document.getElementById('trainerAovFactorSlider');
        const aovFactorValue = document.getElementById('trainerAovFactorValue');
        const cvpInput = document.getElementById('trainerCvpInput');
        const cvpValue = document.getElementById('trainerCvpValue');
        const lactateInput = document.getElementById('trainerLactateInput');
        const lactateValue = document.getElementById('trainerLactateValue');
        const inhaledNoToggle = document.getElementById('trainerInhaledNoToggle');
        const vavEcmoToggle = document.getElementById('trainerVavEcmoToggle');

        // Initialize display values
        updateTrainerControlDisplays_DH();

        lungCapacitySlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            patientData_DH.nativeLungOxygenationCapacity = val;
            lungCapacityValue.textContent = val.toFixed(2);
            logAction_DH(`Trainer: Set Native Lung O2 Capacity to ${val.toFixed(2)}.`, 'trainer');
            if (val > 0.01) patientData_DH.awaitingVentOptimization = false; // If trainer fixes it, no longer waiting.
            triggerFullUpdate_DH();
        });

        lvefSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            patientData_DH.nativeLVEF = val;
            lvefValue.textContent = val.toFixed(2);
            logAction_DH(`Trainer: Set Native LVEF to ${val.toFixed(2)}.`, 'trainer');
            triggerFullUpdate_DH();
        });

        aovFactorSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            patientData_DH.aorticValveOpeningFactor = val;
            aovFactorValue.textContent = val.toFixed(2);
            logAction_DH(`Trainer: Set AoV Opening Factor to ${val.toFixed(2)}.`, 'trainer');
            triggerFullUpdate_DH();
        });
        
        cvpInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            patientData_DH.cvp = val;
            cvpValue.textContent = val.toFixed(0);
            logAction_DH(`Trainer: Override CVP to ${val.toFixed(0)} mmHg.`, 'trainer');
            triggerFullUpdate_DH();
        });

        lactateInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            patientData_DH.lactate = val;
            lactateValue.textContent = val.toFixed(1);
            logAction_DH(`Trainer: Override Lactate to ${val.toFixed(1)} mmol/L.`, 'trainer');
            triggerFullUpdate_DH();
        });

        inhaledNoToggle.addEventListener('change', (e) => {
            patientData_DH.inhaledNOPulmonaryVasodilatorActive = e.target.checked;
            logAction_DH(`Trainer: Set Inhaled NO Active to ${e.target.checked}.`, 'trainer');
            triggerFullUpdate_DH();
        });

        vavEcmoToggle.addEventListener('change', (e) => {
            patientData_DH.vavEcmoActive = e.target.checked;
            if (patientData_DH.vavEcmoActive) {
                patientData_DH.differentialHypoxiaActive = false;
                patientData_DH.awaitingVentOptimization = false; // VAV ECMO often implies scenario shift
                logAction_DH("Trainer: Manually activated VAV ECMO.", "trainer");
            } else {
                logAction_DH("Trainer: Manually deactivated VAV ECMO. Differential hypoxia may re-occur based on physiology.", "trainer");
                // Recalculation will determine if differentialHypoxiaActive should be true
            }
            triggerFullUpdate_DH();
        });
    }
    
    // Updates trainer control UI elements to reflect current patientData_DH
    function updateTrainerControlDisplays_DH() {
        document.getElementById('trainerLungCapacitySlider').value = patientData_DH.nativeLungOxygenationCapacity.toFixed(2);
        document.getElementById('trainerLungCapacityValue').textContent = patientData_DH.nativeLungOxygenationCapacity.toFixed(2);
        document.getElementById('trainerLvefSlider').value = patientData_DH.nativeLVEF.toFixed(2);
        document.getElementById('trainerLvefValue').textContent = patientData_DH.nativeLVEF.toFixed(2);
        document.getElementById('trainerAovFactorSlider').value = patientData_DH.aorticValveOpeningFactor.toFixed(2);
        document.getElementById('trainerAovFactorValue').textContent = patientData_DH.aorticValveOpeningFactor.toFixed(2);
        document.getElementById('trainerCvpInput').value = patientData_DH.cvp.toFixed(0);
        document.getElementById('trainerCvpValue').textContent = patientData_DH.cvp.toFixed(0);
        document.getElementById('trainerLactateInput').value = patientData_DH.lactate.toFixed(1);
        document.getElementById('trainerLactateValue').textContent = patientData_DH.lactate.toFixed(1);
        document.getElementById('trainerInhaledNoToggle').checked = patientData_DH.inhaledNOPulmonaryVasodilatorActive;
        document.getElementById('trainerVavEcmoToggle').checked = patientData_DH.vavEcmoActive;
    }

    // Central function to trigger all necessary UI updates after a change
    function triggerFullUpdate_DH() {
        calculateDerivedPhysiology_DH(); // This must be first
        updateMonitorDisplays_DH();      
        updateControlPanelDisplays_DH(); 
        renderVentilatorParams_DH(); // Update vent params display if needed
        updateTrainerControlDisplays_DH(); // Sync trainer controls if a parameter was changed by intervention/event
        // Waveforms are updated by their own interval (fastUpdateIntervalId_DH) but recalculating physiology might change inputs
    }


    // Handles "Finish Scenario" button click
    document.getElementById('finishScenarioButton').addEventListener('click', () => { 
        clearInterval(simIntervalId_DH); clearInterval(fastUpdateIntervalId_DH); logAction_DH("Scenario Finished.", "event");
        document.getElementById('nextEventButton').disabled = true; document.getElementById('finishScenarioButton').disabled = true;
        document.getElementById('interventionDropdownButton').disabled = true; document.getElementById('diagnosticDropdownButton').disabled = true;   
        document.getElementById('postScenarioOptions').classList.remove('hidden');
        // Disable all interactive controls
        document.querySelectorAll('.input-slider, .dial-btn, #ventModeSelector, #ventilatorSettingsHeader, #trainerControlsHeader, #trainerControlsContent input, #trainerControlsContent button').forEach(el => { 
            el.disabled = true; 
            if(el.classList.contains('cursor-pointer')) el.classList.remove('cursor-pointer'); 
        });
    });
    // Handles "Debriefing" button click
    document.getElementById('debriefingButton').addEventListener('click', () => {
        let debriefHtml = "<h4 class='text-lg font-semibold mb-4 text-gray-800'>Scenario Debrief: VA ECMO & Differential Hypoxia (V2.0)</h4>";
        
        debriefHtml += "<div class='mb-4 border border-gray-200 p-3 rounded-lg bg-sky-50'><h5 class='text-base font-semibold text-sky-700 mb-2'>Ideal Steps in Managing Differential Hypoxia:</h5><ul class='list-disc pl-5 text-sm space-y-1.5 text-gray-700'>";
        const idealSteps = [
            "Recognize & Confirm: High index of suspicion (recovering LV, poor lungs). Monitor R. arm SpO2 vs. lower limb/ECMO SpO2. Perform paired ABGs (R. Radial vs. Femoral/ECMO).",
            "Optimize Native Lung Oxygenation: Increase ventilator FiO2 to 100%. Optimize PEEP and overall ventilation strategy (lung protective, consider recruitment, APRV).",
            "Optimize ECMO Support: Ensure ECMO FiO2 is 100%. Increase ECMO flow to maximize oxygen delivery and potentially enhance proximal mixing.",
            "Improve V/Q Matching in Native Lungs: Consider inhaled pulmonary vasodilators (e.g., iNO).",
            "Address Hemodynamics & Myocardial Oxygen Demand: Maintain adequate MAP. Cautiously consider beta-blockers if severe, refractory differential hypoxia (specialist decision).",
            "Escalate if Refractory: Consult ECMO specialist/cardiac surgery. Consider VAV ECMO or other hybrid cannulation strategies."
        ];
        idealSteps.forEach(step => { debriefHtml += `<li class='ideal-step'>${step}</li>`; });
        debriefHtml += "</ul></div>";

        debriefHtml += "<div class='border border-gray-200 p-3 rounded-lg bg-gray-50'><h5 class='text-base font-semibold text-gray-700 mb-2'>Analysis of Actions Taken (User & Trainer):</h5><ul class='list-disc pl-5 text-sm space-y-1'>";
        
        const actions = patientData_DH.actionsTaken;
        let pairedAbgDone = actions.some(a => a.action.toLowerCase().includes("paired abg"));
        let ventFio2Maxed = actions.some(a => a.action.toLowerCase().includes("ventilator fio2 to 100%"));
        if (!ventFio2Maxed && patientData_DH.ventFiO2 === 100) ventFio2Maxed = true; 
        
        let peepOptimized = actions.some(a => a.action.toLowerCase().includes("increase ventilator peep") && ( (patientData_DH.ventMode === "PCV_AC" && patientData_DH.ventPEEP_PCVAC >= 14) || (patientData_DH.ventMode === "PRVC" && patientData_DH.ventPEEP_PRVC >= 14) || (patientData_DH.ventMode === "APRV" && patientData_DH.ventPLow_APRV >= 6) ));
        if (!peepOptimized && ( (patientData_DH.ventMode === "PCV_AC" && patientData_DH.ventPEEP_PCVAC >= 14) || (patientData_DH.ventMode === "PRVC" && patientData_DH.ventPEEP_PRVC >= 14) || (patientData_DH.ventMode === "APRV" && patientData_DH.ventPLow_APRV >= 6) )) peepOptimized = true;

        let ecmoFlowIncreased = actions.some(a => a.action.toLowerCase().includes("increase ecmo flow") || a.action.toLowerCase().includes("increased ecmo rpm"));
        let vavInitiatedUser = actions.some(a => a.action.toLowerCase().includes("vav ecmo initiated") && a.type !== 'trainer');
        let vavInitiatedTrainer = actions.some(a => a.action.toLowerCase().includes("trainer: manually activated vav ecmo"));
        let vavInitiated = vavInitiatedUser || vavInitiatedTrainer;


        if (pairedAbgDone) { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>Paired ABGs performed - Crucial step taken.</li>"; } 
        else { debriefHtml += "<li class='action-taken-missed'><i class='fas fa-times-circle mr-1'></i>Paired ABGs not performed - Key diagnostic missed for confirmation and quantification.</li>"; }

        if (ventFio2Maxed) { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>Ventilator FiO2 increased to 100% - Correct.</li>"; }
        else { debriefHtml += `<li class='action-taken-consider'><i class='fas fa-exclamation-circle mr-1'></i>Ventilator FiO2 was ${patientData_DH.ventFiO2}%. Consider increasing to 100%.</li>`; }
        if (peepOptimized) { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>PEEP appears to have been optimized (based on set values >= 14 or P-Low >=6).</li>"; }
        else { debriefHtml += "<li class='action-taken-consider'><i class='fas fa-exclamation-circle mr-1'></i>PEEP optimization should be considered.</li>"; }
        if (actions.some(a => a.action.toLowerCase().includes("optimize ventilator strategy"))) { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>'Optimize Ventilator Strategy' selected, implying broader consideration.</li>"; }

        if (patientData_DH.ecmoFiO2 < 100) { debriefHtml += `<li class='action-taken-missed'><i class='fas fa-times-circle mr-1'></i>ECMO FiO2 was ${patientData_DH.ecmoFiO2}%. Should be 100%.</li>`; }
        else { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>ECMO FiO2 maintained at 100% - Correct.</li>"; }
        if (ecmoFlowIncreased) { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>ECMO flow was increased - Potentially beneficial.</li>"; }
        else { debriefHtml += "<li class='action-taken-consider'><i class='fas fa-exclamation-circle mr-1'></i>Increasing ECMO flow could be considered to improve total O2 delivery.</li>"; }
        
        let inhaledNoUser = actions.some(a => a.action.toLowerCase().includes("pulmonary vasodilator") && a.type !== 'trainer');
        let inhaledNoTrainer = actions.some(a => a.action.toLowerCase().includes("trainer: set inhaled no active to true"));
        if (inhaledNoUser || inhaledNoTrainer) { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>Inhaled pulmonary vasodilator administered/activated.</li>"; }
        else { debriefHtml += "<li class='action-taken-consider'><i class='fas fa-exclamation-circle mr-1'></i>Consider inhaled pulmonary vasodilator if appropriate.</li>"; }

        if (vavInitiated) { debriefHtml += `<li class='action-taken-good font-bold'><i class='fas fa-star mr-1'></i>VAV ECMO was initiated${vavInitiatedTrainer ? " by trainer" : ""} - Definitive management.</li>`; }
        else if (patientData_DH.spO2_r_arm < 85 && patientData_DH.scenarioEventTriggers >=1 && !patientData_DH.vavEcmoActive) { 
             debriefHtml += "<li class='action-taken-missed'><i class='fas fa-times-circle mr-1'></i>Differential hypoxia persists/severe. Consider escalating to VAV ECMO.</li>";
        }
        if (actions.some(a => a.action.toLowerCase().includes("consult cardiac surgery"))) { debriefHtml += "<li class='action-taken-good'><i class='fas fa-check-circle mr-1'></i>Specialist consultation sought.</li>"; }

        if (patientData_DH.vavEcmoActive || (!patientData_DH.differentialHypoxiaActive && patientData_DH.spO2_r_arm >=90) ) {
            debriefHtml += "<li class='action-taken-good font-semibold mt-2'>Outcome: Differential hypoxia appears resolved or effectively managed.</li>";
        } else if (patientData_DH.spO2_r_arm < 88) {
            debriefHtml += `<li class='action-taken-missed font-semibold mt-2'>Outcome: Significant upper body hypoxemia (R.Arm SpO2: ${patientData_DH.spO2_r_arm.toFixed(0)}%) persists. Further aggressive management needed.</li>`;
        } else {
             debriefHtml += `<li class='action-taken-consider font-semibold mt-2'>Outcome: Upper body oxygenation (R.Arm SpO2: ${patientData_DH.spO2_r_arm.toFixed(0)}%) requires ongoing attention.</li>`;
        }

        debriefHtml += "</ul></div>";
        debriefHtml += "<div class='mt-2 text-xs text-gray-600'>Note: Green indicates actions aligned with ideal steps. Orange indicates areas for consideration or missed opportunities. Red indicates critical missed steps.</div>";
        showInfoModal_DH("Scenario Debriefing (V2.0)", debriefHtml);
    });

    // Initial setup on window load
    window.onload = () => {
        displayInitialHistory_DH(); 
        document.getElementById('sedationSlider').value = patientData_DH.sedationLevel;
        document.getElementById('paralyticSlider').value = patientData_DH.paralyticLevel;
        document.getElementById('inotropeSlider').value = patientData_DH.inotropeLevel;
        setupDropdown_DH('interventionDropdownButton', 'interventionOptions', 'interventionSelectedText', 'interventionSelectedValue', 'intervention');
        setupDropdown_DH('diagnosticDropdownButton', 'diagnosticOptions', 'diagnosticSelectedText', 'diagnosticSelectedValue', 'diagnostic');
        updateDial_DH('rpm', patientData_DH.ecmoRpm, dialSettings_DH.rpm.min, dialSettings_DH.rpm.max);
        updateDial_DH('sweep', patientData_DH.ecmoSweep, dialSettings_DH.sweep.min, dialSettings_DH.sweep.max);
        updateDial_DH('fio2', patientData_DH.ecmoFiO2, dialSettings_DH.fio2.min, dialSettings_DH.fio2.max);
        ventModeSelector_DH.value = patientData_DH.ventMode;
        
        setupTrainerControls_DH(); // Initialize trainer controls
        
        initAllWaveforms_DH(); 
        initVentilatorWaveform_DH(); 
        
        triggerFullUpdate_DH(); // Initial full update
        
        simIntervalId_DH = setInterval(advanceScenarioState_DH, simulationInterval_DH);
        fastUpdateIntervalId_DH = setInterval(() => { 
            updateMonitorDisplays_DH(); 
            updateControlPanelDisplays_DH(); 
            updateVentilatorWaveform_DH(); 
            updateEcgWaveform_DH(); 
            updateArterialLineChart_DH(); 
            updateSpo2PlethWaveform_DH(); 
            // Trainer displays are updated on input or by triggerFullUpdate, not necessarily every fast tick.
        }, fastUpdateInterval_DH);
    };
</script>
</body>
</html>
